<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cjyc.common.model.dao.IDriverDao">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.cjyc.common.model.entity.Driver">
        <id column="id" property="id" />
        <result column="user_id" property="userId" />
        <result column="name" property="name" />
        <result column="phone" property="phone" />
        <result column="emergency_phone" property="emergencyPhone" />
        <result column="type" property="type" />
        <result column="identity" property="identity" />
        <result column="id_card" property="idCard" />
        <result column="real_name" property="realName" />
        <result column="age" property="age" />
        <result column="sex" property="sex" />
        <result column="address" property="address" />
        <result column="id_card_front_img" property="idCardFrontImg" />
        <result column="id_card_back_img" property="idCardBackImg" />
        <result column="driver_licence_front_img" property="driverLicenceFrontImg" />
        <result column="driver_licence_back_img" property="driverLicenceBackImg" />
        <result column="travel_licence_front_img" property="travelLicenceFrontImg" />
        <result column="travel_licence_back_img" property="travelLicenceBackImg" />
        <result column="taxi_licence_front_img" property="taxiLicenceFrontImg" />
        <result column="taxi_licence_back_img" property="taxiLicenceBackImg" />
        <result column="qualifi_cert_front_img" property="qualifiCertFrontImg" />
        <result column="qualifi_cert_back_img" property="qualifiCertBackImg" />
        <result column="remark" property="remark" />
        <result column="deposit_pay_state" property="depositPayState" />
        <result column="business_state" property="businessState" />
        <result column="source" property="source" />
        <result column="photo_img" property="photoImg" />
        <result column="create_time" property="createTime" />
        <result column="create_user_id" property="createUserId" />
        <result column="check_time" property="checkTime" />
        <result column="check_user_id" property="checkUserId" />
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, user_id, name, phone, emergency_phone, type, identity, id_card, real_name, age, sex, address, id_card_front_img, id_card_back_img, driver_licence_front_img, driver_licence_back_img, travel_licence_front_img, travel_licence_back_img, taxi_licence_front_img, taxi_licence_back_img, qualifi_cert_front_img, qualifi_cert_back_img, remark, deposit_pay_state, business_state, source, photo_img, create_time, create_user_id, check_time, check_user_id
    </sql>

    <select id="findList" resultType="com.cjyc.common.model.vo.web.user.DriverListVo">
        select
        c.`name` as `carrierName`,
        c.type as carrierType,
        c.settle_type as settleType,
        d.user_id as userId,
        d.`name` as `name`,
        d.real_name as realName,
        d.phone as phone,
        d.type as type,
        d.`mode` as `mode`,
        d.id_card as idCard,
        r.plate_no as plateNo,
        r.running_state as runningState
        from d_carrier c
        join d_carrier_driver_con con on con.carrier_id = c.id
        join d_driver d on con.driver_id = d.id
        LEFT JOIN d_vehicle_running r on d.id = r.driver_id
        <where>
            <choose>
                <when test="paramsDto.queryType == 1">
                    and d.type = 0
                </when>
                <when test="paramsDto.queryType == 2">
                    and d.type != 0 and (d.mode = 1 or d.mode = 3)
                </when>
                <otherwise>
                    and d.type != 0 and (d.mode = 2 or d.mode = 3)
                </otherwise>
            </choose>

            <if test="paramsDto.name != null">
                and d.name like CONCAT('%',#{name},'%')
            </if>
            <if test="paramsDto.name != null">
                and d.real_name like CONCAT('%',#{name},'%')
            </if>
            <if test="paramsDto.idCard != null">
                and r.id_card like CONCAT('%',#{idCard},'%')
            </if>
            <if test="paramsDto.plateNo != null">
                and r.plate_no like CONCAT('%',#{plateNo},'%')
            </if>
        </where>
    </select>
    <!--根据承运商查询承运商唯一的司机-->
    <select id="findTopByCarrierId" resultType="com.cjyc.common.model.entity.Driver">
        select
        d.*
        from d_driver d
        join d_carrier_driver_con con
        where con.carrier_id = #{carrierId}
        limit 1
    </select>

    <!--根据条件查询司机信息-->
    <select id="getDriverByTerm" resultType="com.cjyc.common.model.vo.web.driver.DriverVo"
            parameterType="com.cjyc.common.model.dto.web.driver.SelectDriverDto">
        SELECT
            dc.id AS carrierId,
            dd.id AS driverId,
            dd.real_name AS realName,
            dd.phone AS phone,
            dcdc.MODE AS MODE,
            dc.settle_type AS settleType,
            dv.plate_no AS plateNo,
            sbcb.card_name AS cardName,
            sbcb.bank_name AS bankName,
            sbcb.card_no AS cardNo,
            dd.id_card_front_img AS idCardFrontImg,
            dd.id_card_back_img AS idCardBackImg,
            dd.driver_licence_front_img AS driverLicenceFrontImg,
            dd.travel_licence_front_img AS travelLicenceFrontImg,
            dd.taxi_licence_front_img AS taxiLicenceFrontImg,
            dd.qualifi_cert_front_img AS qualifiCertFrontImg,
            dd.source AS source,
            dcdc.state AS state,
            dvr.running_state AS runningState,
            dd.check_time as operatTime,
            ba.NAME AS operator
        FROM
            d_carrier dc
        LEFT JOIN d_carrier_driver_con dcdc ON dcdc.carrier_id = dc.id
        LEFT JOIN d_driver dd ON dd.id = dcdc.driver_id
        LEFT JOIN s_bank_card_bind sbcb ON sbcb.user_id = dc.id
        LEFT JOIN d_driver_vehicle_con ddvc ON ddvc.driver_id = dd.id
        LEFT JOIN d_vehicle dv ON dv.id = ddvc.vehicle_id
        LEFT JOIN d_vehicle_running dvr ON dvr.driver_id = dd.id
        LEFT JOIN b_admin ba ON ba.id = dd.check_user_id
        <where>
            <if test="realName != null and realName.trim() != ''">
                dd.real_name like CONCAT('%',#{realName},'%')
            </if>
            <if test="phone != null and phone.trim() != ''">
                and  dd.phone = #{phone}
            </if>
            <if test="idCard != null and idCard.trim() != ''">
                and  dd.id_card = #{idCard}
            </if>
            <if test="plateNo != null and plateNo.trim() != ''">
                and  dv.plate_no = #{plateNo}
            </if>
            <if test="identity != null">
                and  dd.identity = #{identity}
            </if>
            <if test="runningState != null">
                and  dvr.running_state = #{runningState}
            </if>
            <if test="state != null">
                and  dc.state = #{state}
            </if>
            <if test="mode != null">
                and  dcdc.mode = #{mode}
            </if>
            and  dc.type = 1 and dd.identity = 0
        </where>
    </select>

    <!--根据司机id/userId查看司机信息-->
    <select id="getDriverById" resultType="com.cjyc.common.model.vo.web.driver.ShowDriverVo">
        SELECT
            dc.id AS carrierId,
            dd.id AS driverId,
            dd.real_name AS realName,
            dd.phone AS phone,
            dcdc.MODE AS MODE,
            dd.id_card AS idCard,
            sbcb.card_name AS cardName,
            sbcb.bank_name AS bankName,
            sbcb.card_no AS cardNo,
            dd.id_card_front_img AS idCardFrontImg,
            dd.id_card_back_img AS idCardBackImg,
            dd.driver_licence_front_img AS driverLicenceFrontImg,
            dd.driver_licence_back_img AS driverLicenceBackImg,
            dd.travel_licence_front_img AS travelLicenceFrontImg,
            dd.travel_licence_back_img AS travelLicenceBackImg,
            dd.taxi_licence_front_img AS taxiLicenceFrontImg,
            dd.taxi_licence_back_img AS taxiLicenceBackImg,
            dd.qualifi_cert_front_img AS qualifiCertFrontImg,
            dd.qualifi_cert_back_img AS qualifiCertBackImg,
            dvr.vehicle_id AS vehicleId,
            dvr.plate_no AS plateNo,
            dvr.carry_car_num AS defaultCarryNum
      FROM
          d_carrier dc
        LEFT JOIN d_carrier_driver_con dcdc ON dcdc.carrier_id = dc.id
        LEFT JOIN d_driver dd ON dd.id = dcdc.driver_id
        LEFT JOIN d_vehicle_running dvr ON dvr.driver_id = dd.id
        LEFT JOIN s_bank_card_bind sbcb ON sbcb.user_id = dc.id
          WHERE
            dc.id = #{carrierId}
    </select>

    <!--根据承运商id查询司机信息-->
    <select id="getDriverByCarrierId" resultType="com.cjyc.common.model.entity.Driver" parameterType="java.lang.Long">
        SELECT
            dri.id AS id,
            dri.user_id as userId,
            dri.name as name,
            dri.real_name as realName,
            dri.id_card as idCard,
            dri.phone AS phone
        FROM
            d_driver dri
            JOIN d_carrier_driver_con cdc ON cdc.driver_id = dri.id
            JOIN d_carrier carr ON carr.id = cdc.carrier_id
        WHERE carr.id = #{carrierId} and cdc.role = 3
    </select>
    <select id="findByUserId" resultType="com.cjyc.common.model.entity.Driver">
        select
        <include refid="Base_Column_List"/>
        from d_driver
        where user_id = #{userId}

    </select>

    <!--根据司机id获取承运商id-->
    <select id="getCarrIdByDriverId" resultType="java.lang.Long" parameterType="java.lang.Long">
      SELECT
            carr.id
        FROM
            d_carrier carr
            JOIN d_carrier_driver_con cdc ON cdc.carrier_id = carr.id
            JOIN d_driver driver ON cdc.driver_id = driver.id
        WHERE
            driver.id = #{driverId}
    </select>

    <!--根据司机ids获取司机信息-->
    <select id="getDriversByIds" resultType="com.cjyc.common.model.vo.web.carrier.BaseDriverVo">
          SELECT
            dri.id AS driverId,
            dri.realName AS realName,
            dri.phone AS phone,
            dri.MODE AS MODE,
            dri.business_state AS businessState,
            dri.state AS state,
            dri.identity AS identity,
            veh.plate_no AS plateNo,
            veh.default_carry_num AS defaultCarryNum
        FROM
            d_driver dri
            left JOIN d_driver_vehicle_con dvc ON dvc.driver_id = dri.id
            left JOIN d_vehicle veh ON veh.id = dvc.vehicle_id
        WHERE dri.id in
        <foreach collection="list" item="item" index="index" open="(" close=")" separator=",">
            #{driverIds}
        </foreach>
    </select>

    <!--查询(承运商查看中的)该承该运商下的司机-->
    <select id="findTransportDriver" resultType="com.cjyc.common.model.vo.web.carrier.TransportDriverVo"
                    parameterType="com.cjyc.common.model.dto.web.carrier.TransportDto">
        SELECT
            dd.id AS driverId,
            dcdc.carrier_id AS carrierId,
            dd.real_name AS realName,
            dd.phone AS phone,
            dcdc.MODE AS MODE,
            dd.id_card as idCard,
            dd.business_state AS businessState,
            dd.id_card_front_img as idCardFrontImg,
            dd.id_card_back_img as idCardBackImg,
            dcdc.state AS state,
            dd.identity AS identity,
            dvr.vehicle_id as vehicleId,
            dvr.plate_no AS plateNo,
            dvr.carry_car_num AS defaultCarryNum
            FROM
            d_driver dd
        LEFT JOIN d_carrier_driver_con dcdc ON dcdc.driver_id = dd.id
        LEFT JOIN d_carrier dc ON dc.id = dcdc.carrier_id
        LEFT JOIN d_vehicle_running dvr ON dvr.driver_id = dd.id
        <where>
            <if test="realName != null and realName.trim() != ''">
                dd.real_name like CONCAT('%',#{realName},'%')
            </if>
            <if test="phone != null and phone.trim() != ''">
                and  dd.phone = #{phone}
            </if>
            <if test="plateNo != null and plateNo.trim() != ''">
                and  dvr.plate_no = #{plateNo}
            </if>
            and dc.id = #{carrierId} and dc.type = 2 and dc.state &lt; 9
        </where>
    </select>

    <!--查询该承该运商下的司机-->
    <select id="findMyDriver" resultType="com.cjyc.common.model.vo.web.mineCarrier.MyDriverVo"
                                parameterType="com.cjyc.common.model.dto.web.mineCarrier.QueryMyDriverDto">
        SELECT
            dd.id AS driverId,
            dcdc.carrier_id AS carrierId,
            dd.real_name AS realName,
            dd.phone AS phone,
            dcdc.MODE AS MODE,
            dd.business_state AS businessState,
            dcdc.state AS state,
            dd.identity AS identity,
            dvr.plate_no AS plateNo,
            dvr.carry_car_num AS defaultCarryNum
        FROM
          d_driver dd
        LEFT JOIN d_carrier_driver_con dcdc ON dcdc.driver_id = dd.id
        LEFT JOIN d_carrier dc ON dc.id = dcdc.carrier_id
        LEFT JOIN d_vehicle_running dvr ON dvr.driver_id = dd.id
        <where>
            <if test="realName != null and realName.trim() != ''">
                dd.real_name like CONCAT('%',#{realName},'%')
            </if>
            <if test="phone != null and phone.trim() != ''">
                and  dd.phone = #{phone}
            </if>
            <if test="idCard != null and idCard.trim() != ''">
                and  dd.id_card = #{idCard}
            </if>
            <if test="plateNo != null and plateNo.trim() != ''">
                and  dvr.plate_no = #{plateNo}
            </if>
            <if test="identity != null">
                and  dd.identity = #{identity}
            </if>
            <if test="runningState != null">
                and  dvr.running_state = #{businessState}
            </if>
            <if test="state != null">
                and  dcdc.state = #{state}
            </if>
            <if test="mode != null">
                and  dcdc.mode = #{mode}
            </if>
            and dd.id in
            <foreach collection="driverIds" item="item" index="index" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </where>
    </select>

    <!--根据承运商id和司机姓名司机-->
    <select id="findCarrierDriver" resultType="com.cjyc.common.model.vo.FreeDriverVo"
                parameterType="com.cjyc.common.model.dto.FreeDto">
        SELECT
            dd.id AS driverId,
            dd.real_name AS realName,
            dd.phone AS phone,
            dcdc.MODE AS MODE
        FROM
            d_driver dd
	    LEFT JOIN d_carrier_driver_con dcdc ON dcdc.driver_id = dd.id
        <where>
            <if test="realName != null and realName.trim() != ''">
                dd.real_name like CONCAT('%',#{realName},'%')
            </if>
              and dcdc.id = #{roleId} and dcdc.state=2 and dd.id = #{loginId}
        </where>
    </select>

    <!--根据承运商查询绑定的司机-->
    <select id="findCarrierBusyDriver" resultType="java.lang.Long" parameterType="java.lang.Long">
        SELECT
            ddvc.driver_id
        FROM
            d_driver_vehicle_con ddvc
            LEFT JOIN d_vehicle dv ON dv.id = ddvc.vehicle_id
        where dv.carrier_id = #{carrierId}
    </select>

    <!--查询符合条件的调度个人司机-->
    <select id="getDispatchDriver" resultType="com.cjyc.common.model.vo.web.driver.DispatchDriverVo"
                                    parameterType="com.cjyc.common.model.dto.web.driver.DispatchDriverDto">
        SELECT
            cr.id as carrierId,
            cr.`name` as `name`,
            d.id AS driverId,
            d.real_name AS driverName,
            d.phone AS driverPhone,
            vr.plate_no AS vehiclePlateNo,
            d.id_card AS idCard,
            vr.carry_car_num AS carryCarNum,
            vr.occupied_car_num AS occupiedCarNum,
            vr.running_state AS runningState,
            con.mode as mode
        FROM d_carrier cr
        LEFT JOIN d_carrier_driver_con con on con.carrier_id = cr.id
        LEFT JOIN d_driver d on con.driver_id = d.id
        LEFT JOIN d_vehicle_running vr ON vr.driver_id = d.id
        <where>
            <if test="realName != null and realName.trim() != ''">
                and d.real_name like CONCAT('%',#{realName},'%')
            </if>
            <if test="plateNo != null and plateNo.trim() != ''">
                and vr.plate_no = #{plateNo}
            </if>
            <if test="phone != null and phone.trim() != ''">
                and d.phone = #{phone}
            </if>
            <if test="idCard != null and idCard.trim() != ''">
                and d.id_card = #{idCard}
            </if>
            and d.type = 2
            AND con.state = 2
            AND d.business_state = 0
        </where>
    </select>



    <!--通过承运商id获取司机-->
    <select id="findDriverByCarrierId" parameterType="java.lang.Long"
                                    resultType="com.cjyc.common.model.entity.Driver">
        SELECT
          <include refid="Base_Column_List"/>
        FROM
            d_driver d
            LEFT JOIN d_carrier_driver_con con ON con.driver_id = d.id
            LEFT JOIN d_carrier c ON c.id = con.carrier_id
        WHERE
	    c.id = #{carrierId}
    </select>
    <select id="findAll" resultType="com.cjyc.common.model.entity.Driver">
        select * from d_driver
    </select>
    <select id="findAllNo" resultType="java.lang.String">
        select no from d_driver
    </select>

    <!--根据管理员司机id获取符合条件的司机集合-->
    <select id="findDriverIds" resultType="java.lang.Long" parameterType="java.lang.Long">
        SELECT
          dcdc.driver_id
        FROM
          d_driver dd
        LEFT JOIN d_carrier_driver_con dcdc ON dcdc.driver_id = dd.id
        LEFT JOIN d_carrier dc ON dc.id = dcdc.carrier_id
        WHERE
          dd.id = #{driverId}
        AND dcdc.state &lt; 9
        AND dc.state &lt; 9
    </select>

    <!--根据司机ids获取司机信息-->
    <select id="findDriverInfo" resultType="com.cjyc.common.model.vo.driver.mine.DriverInfoVo"
                        parameterType="java.lang.Long">
          SELECT
            dc.id as carrierId,
            dd.id AS driverId,
            dd.real_name AS realName,
            dd.phone AS phone,
            dd.id_card AS idCard,
            dd.id_card_front_img AS idCardFrontImg,
            dd.id_card_back_img AS idCardBackImg,
            dcdc.MODE AS MODE,
            dd.business_state AS businessState,
            dvr.vehicle_id AS vehicleId,
            dvr.plate_no AS plateNo
      FROM
          d_driver dd
        LEFT JOIN d_carrier_driver_con dcdc ON dcdc.driver_id = dd.id
        LEFT JOIN d_carrier dc ON dc.id = dcdc.carrier_id
        LEFT JOIN d_vehicle_running dvr ON dvr.driver_id = dd.id
        where dd.id in
        <foreach collection="driverIds" item="item" index="index" open="(" close=")" separator=",">
            #{item}
        </foreach>
    </select>

    <!--根据司机所在的承运商id获取司机信息-->
    <select id="selectDriverList" parameterType="com.cjyc.common.model.dto.driver.task.DriverQueryDto"
            resultType="com.cjyc.common.model.vo.driver.task.TaskDriverVo">
        select
            con.role as role,
            con.driver_id as driverId,
            run.carry_car_num as carryCarNum,
            run.occupied_car_num as occupiedCarNum,
            run.plate_no as plateNo,
            run.running_state as runningState,
            d.real_name as realName,
            d.id_card as idCard,
            d.phone as phone,
            d.id as loginId
        from
            d_vehicle_running run
            left join d_driver d on run.driver_id=d.id
            left join d_carrier_driver_con con on run.driver_id=con.driver_id
        <where>
            run.state= 1 and con.state = ${@com.cjyc.common.model.enums.CommonStateEnum@CHECKED.code} and con.carrier_id=#{carrierId}
            <if test="keyword != null and keyword.trim() != ''">
                and (
                d.real_name like CONCAT('%',#{keyword},'%')
                or d.phone like CONCAT('%',#{keyword},'%')
                or run.plate_no like CONCAT('%',#{keyword},'%')
                )
            </if>
        </where>
    </select>

    <!--获取司机端我的车辆-->
    <select id="findVehicle" resultType="com.cjyc.common.model.vo.driver.mine.DriverVehicleVo"
            parameterType="java.lang.Long">
            SELECT
                dd.id AS driverId,
                dd.real_name AS realName,
                dd.phone AS phone,
                dvr.vehicle_id AS vehicleId,
                dvr.plate_no AS plateNo,
                dvr.carry_car_num AS carryCarNum,
                dvr.occupied_car_num AS occupiedCarNum
          FROM
            d_driver dd
          LEFT JOIN d_vehicle_running dvr ON dvr.driver_id = dd.id
          where dd.id in
        <foreach collection="driverIds" item="item" index="index" open="(" close=")" separator=",">
            #{item}
        </foreach>
    </select>

    <!--获取该承运商下符合条件的司机-->
    <select id="findCarrierAllDriver" resultType="com.cjyc.common.model.vo.FreeDriverVo"
                parameterType="com.cjyc.common.model.dto.driver.mine.CarrierDriverNameDto">
        SELECT
            dd.id AS driverId,
            dd.real_name AS realName,
            dd.phone AS phone,
            dcdc.MODE AS MODE
        FROM
            d_driver dd
            LEFT JOIN d_carrier_driver_con dcdc ON dcdc.driver_id = dd.id
        <where>
            <if test="realName != null and realName.trim() != ''">
                and dd.real_name like CONCAT('%',#{realName},'%')
            </if>
            and dcdc.carrier_id = #{carrierId}
            and dcdc.state = 2
        </where>
    </select>

    <!--司机端查询个人司机信息-->
    <select id="findPersonInfo" resultType="com.cjyc.common.model.vo.driver.mine.PersonDriverVo"
                parameterType="com.cjyc.common.model.dto.driver.BaseDriverDto">
        SELECT
            dd.real_name AS realName,
            dd.phone AS phone,
            dd.id_card AS idCard,
            IFNULL(dvr.vehicle_id,0) AS vehicleId,
            IFNULL(dvr.plate_no,'') AS plateNo,
            dcdc.MODE AS MODE,
            dd.id_card_front_img AS idCardFrontImg,
            dd.id_card_back_img AS idCardBackImg,
            IFNULL(dd.driver_licence_front_img,'') AS driverLicenceFrontImg,
            IFNULL(dd.qualifi_cert_front_img,'') AS qualifiCertFrontImg,
            IFNULL(dd.taxi_licence_front_img,'') AS taxiLicenceFrontImg,
            IFNULL(dd.travel_licence_front_img,'') AS travelLicenceFrontImg
        FROM
            d_driver dd
            LEFT JOIN d_carrier_driver_con dcdc ON dcdc.driver_id = dd.id
            LEFT JOIN d_vehicle_running dvr ON dvr.driver_id = dd.id
        where dcdc.id = #{roleId} and dd.id = #{loginId}
            and dcdc.state &lt; 9
    </select>

    <!--验证在企业承运商下是否存在-->
    <select id="existEnterPriseDriver" resultType="java.lang.Integer"
                        parameterType="com.cjyc.common.model.dto.driver.mine.PersonDriverDto">
        SELECT
            count( dd.id )
        FROM
            d_driver dd
            LEFT JOIN d_carrier_driver_con dcdc ON dcdc.driver_id = dd.id
            LEFT JOIN d_carrier dc ON dc.id = dcdc.carrier_id
        WHERE
            dc.type = 2
            AND ( dd.phone = #{phone} OR dd.id_card = #{idCard})
    </select>


    <!--验证在个人承运商下是否存在-->
    <select id="existPersonDriver" resultType="java.lang.Integer"
            parameterType="com.cjyc.common.model.dto.driver.mine.PersonDriverDto">
        SELECT
            count( dd.id )
        FROM
            d_driver dd
            LEFT JOIN d_carrier_driver_con dcdc ON dcdc.driver_id = dd.id
            LEFT JOIN d_carrier dc ON dc.id = dcdc.carrier_id
        WHERE
            dc.type = 1
            AND ( dd.phone = #{phone} and dd.id_card = #{idCard})
            and dd.id &lt;&gt; #{loginId}
    </select>

</mapper>
