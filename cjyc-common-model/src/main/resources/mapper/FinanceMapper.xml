<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cjyc.common.model.dao.IFinanceDao">

    <select id="getFinanceList" parameterType="com.cjyc.common.model.dto.web.finance.FinanceQueryDto"
            resultType="com.cjyc.common.model.vo.web.finance.FinanceVo">
        select * from (select DISTINCT(woc.no),woc.vin,woc.brand,woc.model,woc.order_no as orderNo,
        zcity.name as largeArea,
        wo.input_store_name as inputStoreName,wo.start_city as startAddress,
        wo.end_city as endAddress,
        woc.finish_time as deliveryDate,

        wo.customer_id as customerId,
        wo.customer_type as type,cc.name as customerName,
        cc.pay_mode as payMode,
        if(wo.customer_type=3,woc.total_fee,null) as feeShare,
        if(wo.customer_type=3,woc.total_fee,(woc.total_fee-woc.coupon_offset_fee)) as freightReceivable,
        (CASE
        when wo.customer_type=3 and woc.wl_pay_state=2 THEN woc.total_fee
        when wo.customer_type!=3 and woc.wl_pay_state=2 THEN woc.total_fee-woc.coupon_offset_fee
        END
        ) as amountReceived,
        if(woc.wl_pay_state=2,(woc.pick_fee+woc.trunk_fee+woc.back_fee+woc.add_insurance_fee-woc.coupon_offset_fee),0)
        as totalIncome,
        woc.wl_pay_time as receivedTime,
        woc.finish_time

        from w_order_car woc
        left join w_order wo on woc.order_no = wo.no
        left join c_customer cc on wo.customer_id = cc.id
        left join w_waybill_car wwc on woc.id = wwc.order_car_id
        left join w_task_car wtc on wtc.waybill_car_id = wwc.id
        left join w_task wt on wtc.task_id = wt.id
        left join s_city zc on zc.code = wo.start_province_code
        left join s_city zcity on zcity.code = zc.parent_code
        where wo.state=100 and wo.customer_type=1
        <include refid="financeListCondition"></include>
        group by woc.no

        UNION
        select DISTINCT(woc.no),woc.vin,woc.brand,woc.model,woc.order_no as orderNo,
        zcity.name as largeArea,
        wo.input_store_name as inputStoreName,wo.start_city as startAddress,
        wo.end_city as endAddress,
        woc.finish_time as deliveryDate,

        wo.customer_id as customerId,
        wo.customer_type as type,cc.name as customerName,
        ccc.settle_type as payMode,
        if(wo.customer_type=3,woc.total_fee,null) as feeShare,
        if(wo.customer_type=3,woc.total_fee,(woc.total_fee-woc.coupon_offset_fee)) as freightReceivable,
        (CASE
        when wo.customer_type=3 and woc.wl_pay_state=2 THEN woc.total_fee
        when wo.customer_type!=3 and woc.wl_pay_state=2 THEN woc.total_fee-woc.coupon_offset_fee
        END
        ) as amountReceived,
        if(woc.wl_pay_state=2,(woc.pick_fee+woc.trunk_fee+woc.back_fee+woc.add_insurance_fee-woc.coupon_offset_fee),0)
        as totalIncome,
        woc.wl_pay_time as receivedTime,
        woc.finish_time
        from w_order_car woc
        left join w_order wo on woc.order_no = wo.no
        left join c_customer cc on wo.customer_id = cc.id
        LEFT JOIN c_customer_contract ccc on cc.id = ccc.customer_id AND ccc.id = wo.customer_contract_id
        left join w_waybill_car wwc on woc.id = wwc.order_car_id
        left join w_task_car wtc on wtc.waybill_car_id = wwc.id
        left join w_task wt on wtc.task_id = wt.id
        left join s_city zc on zc.code = wo.start_province_code
        left join s_city zcity on zcity.code = zc.parent_code
        where wo.state=100 and wo.customer_type=2
        <include refid="financeListCondition"></include>
        group by woc.no

        UNION
        select DISTINCT(woc.no),woc.vin,woc.brand,woc.model,woc.order_no as orderNo,
        zcity.name as largeArea,
        wo.input_store_name as inputStoreName,wo.start_city as startAddress,
        wo.end_city as endAddress,
        woc.finish_time as deliveryDate,

        wo.customer_id as customerId,
        wo.customer_type as type,cc.name as customerName,
        ccp.settle_type as payMode,
        if(wo.customer_type=3,woc.total_fee,null) as feeShare,
        if(wo.customer_type=3,woc.total_fee,(woc.total_fee-woc.coupon_offset_fee)) as freightReceivable,
        (CASE
        when wo.customer_type=3 and woc.wl_pay_state=2 THEN woc.total_fee
        when wo.customer_type!=3 and woc.wl_pay_state=2 THEN woc.total_fee-woc.coupon_offset_fee
        END
        ) as amountReceived,
        if(woc.wl_pay_state=2,(woc.pick_fee+woc.trunk_fee+woc.back_fee+woc.add_insurance_fee-woc.coupon_offset_fee),0)
        as totalIncome,
        woc.wl_pay_time as receivedTime,
        woc.finish_time
        from w_order_car woc
        left join w_order wo on woc.order_no = wo.no
        left join c_customer cc on wo.customer_id = cc.id
        LEFT JOIN c_customer_partner ccp on cc.id = ccp.customer_id
        left join w_waybill_car wwc on woc.id = wwc.order_car_id
        left join w_task_car wtc on wtc.waybill_car_id = wwc.id
        left join w_task wt on wtc.task_id = wt.id
        left join s_city zc on zc.code = wo.start_province_code
        left join s_city zcity on zcity.code = zc.parent_code
        where wo.state=100 and wo.customer_type=3
        <include refid="financeListCondition"></include>
        group by woc.no
        ) t order by t.finish_time desc

    </select>

    <sql id="financeListCondition">
        <if test="no != null and no.trim() != ''">
            and woc.no like concat('%',#{no},'%')
        </if>
        <if test="vin != null and vin.trim() != ''">
            and woc.vin like concat('%',#{vin},'%')
        </if>
        <if test="orderNo != null and orderNo.trim() != ''">
            and woc.order_no like concat('%',#{orderNo},'%')
        </if>
        <if test="completeStartTime!= null">
            and woc.finish_time &gt;= #{completeStartTime}
        </if>
        <if test="completeEndTime!= null">
            and woc.finish_time &lt;= #{completeEndTime}
        </if>

        <if test="startProvinceCode != null and startProvinceCode.trim() != ''">
            and wo.start_province_code = #{startProvinceCode}
        </if>
        <if test="startCityCode != null and startCityCode.trim() != ''">
            and wo.start_city_code = #{startCityCode}
        </if>
        <if test="startAreaCode != null and startAreaCode.trim() != ''">
            and wo.start_area_code = #{startAreaCode}
        </if>
        <if test="endProvinceCode != null and endProvinceCode.trim() != ''">
            and wo.end_province_code = #{endProvinceCode}
        </if>
        <if test="endCityCode != null and endCityCode.trim() != ''">
            and wo.end_city_code = #{endCityCode}
        </if>
        <if test="endAreaCode != null and endAreaCode.trim() != ''">
            and wo.end_area_code = #{endAreaCode}
        </if>
        <if test="area != null and area.trim() != ''">
            and zcity.code = #{area}
        </if>
        <if test="type != null">
            and cc.type = #{type}
        </if>
        <if test="customerName != null  and customerName.trim() != ''">
            and cc.name like concat('%',#{customerName},'%')
        </if>
        <if test="payMode != null">
            and cc.pay_mode =#{payMode}
        </if>

        <if test="brand != null and brand.trim() != ''">
            and woc.brand = #{brand}
        </if>
        <if test="model != null and model.trim() != ''">
            and woc.model = #{model}
        </if>
        <if test="inputStoreName != null and inputStoreName.trim() != ''">
            and wo.input_store_name = #{inputStoreName}
        </if>

        <if test="state != null and state.trim() !=''">
            and woc.wl_pay_state = #{state}
        </if>
        <if test="receiveStartTime!= null">
            and woc.wl_pay_time >= #{receiveStartTime}
        </if>
        <if test="receiveEndTime!= null">
            and woc.wl_pay_time &lt;= #{receiveEndTime}
        </if>
    </sql>

    <select id="getAllFinanceList" parameterType="com.cjyc.common.model.dto.web.finance.FinanceQueryDto"
            resultType="com.cjyc.common.model.vo.web.finance.ExportFinanceVo">
        select * from (select DISTINCT(woc.no),woc.vin,woc.brand,woc.model,woc.order_no as orderNo,
        zcity.name as largeArea,
        wo.input_store_name as inputStoreName,wo.start_city as startAddress,
        wo.end_city as endAddress,
        woc.finish_time as deliveryDate,

        wo.customer_id as customerId,
        wo.customer_type as type,cc.name as customerName,
        cc.pay_mode as payMode,
        if(wo.customer_type=3,woc.total_fee,null) as feeShare,
        if(wo.customer_type=3,woc.total_fee,(woc.total_fee-woc.coupon_offset_fee)) as freightReceivable,
        (CASE
        when wo.customer_type=3 and woc.wl_pay_state=2 THEN woc.total_fee
        when wo.customer_type!=3 and woc.wl_pay_state=2 THEN woc.total_fee-woc.coupon_offset_fee
        END
        ) as amountReceived,
        if(woc.wl_pay_state=2,(woc.pick_fee+woc.trunk_fee+woc.back_fee+woc.add_insurance_fee-woc.coupon_offset_fee),0)
        as totalIncome,
        woc.wl_pay_time as receivedTime,
        woc.finish_time

        from w_order_car woc
        left join w_order wo on woc.order_no = wo.no
        left join c_customer cc on wo.customer_id = cc.id
        left join w_waybill_car wwc on woc.id = wwc.order_car_id
        left join w_task_car wtc on wtc.waybill_car_id = wwc.id
        left join w_task wt on wtc.task_id = wt.id
        left join s_city zc on zc.code = wo.start_province_code
        left join s_city zcity on zcity.code = zc.parent_code
        where wo.state=100 and wo.customer_type=1
        <include refid="financeListCondition"></include>
        group by woc.no

        UNION
        select DISTINCT(woc.no),woc.vin,woc.brand,woc.model,woc.order_no as orderNo,
        zcity.name as largeArea,
        wo.input_store_name as inputStoreName,wo.start_city as startAddress,
        wo.end_city as endAddress,
        woc.finish_time as deliveryDate,

        wo.customer_id as customerId,
        wo.customer_type as type,cc.name as customerName,
        ccc.settle_type as payMode,
        if(wo.customer_type=3,woc.total_fee,null) as feeShare,
        if(wo.customer_type=3,woc.total_fee,(woc.total_fee-woc.coupon_offset_fee)) as freightReceivable,
        (CASE
        when wo.customer_type=3 and woc.wl_pay_state=2 THEN woc.total_fee
        when wo.customer_type!=3 and woc.wl_pay_state=2 THEN woc.total_fee-woc.coupon_offset_fee
        END
        ) as amountReceived,
        if(woc.wl_pay_state=2,(woc.pick_fee+woc.trunk_fee+woc.back_fee+woc.add_insurance_fee-woc.coupon_offset_fee),0)
        as totalIncome,
        woc.wl_pay_time as receivedTime,
        woc.finish_time
        from w_order_car woc
        left join w_order wo on woc.order_no = wo.no
        left join c_customer cc on wo.customer_id = cc.id
        LEFT JOIN c_customer_contract ccc on cc.id = ccc.customer_id AND ccc.id = wo.customer_contract_id
        left join w_waybill_car wwc on woc.id = wwc.order_car_id
        left join w_task_car wtc on wtc.waybill_car_id = wwc.id
        left join w_task wt on wtc.task_id = wt.id
        left join s_city zc on zc.code = wo.start_province_code
        left join s_city zcity on zcity.code = zc.parent_code
        where wo.state=100 and wo.customer_type=2
        <include refid="financeListCondition"></include>
        group by woc.no

        UNION
        select DISTINCT(woc.no),woc.vin,woc.brand,woc.model,woc.order_no as orderNo,
        zcity.name as largeArea,
        wo.input_store_name as inputStoreName,wo.start_city as startAddress,
        wo.end_city as endAddress,
        woc.finish_time as deliveryDate,

        wo.customer_id as customerId,
        wo.customer_type as type,cc.name as customerName,
        ccp.settle_type as payMode,
        if(wo.customer_type=3,woc.total_fee,null) as feeShare,
        if(wo.customer_type=3,woc.total_fee,(woc.total_fee-woc.coupon_offset_fee)) as freightReceivable,
        (CASE
        when wo.customer_type=3 and woc.wl_pay_state=2 THEN woc.total_fee
        when wo.customer_type!=3 and woc.wl_pay_state=2 THEN woc.total_fee-woc.coupon_offset_fee
        END
        ) as amountReceived,
        if(woc.wl_pay_state=2,(woc.pick_fee+woc.trunk_fee+woc.back_fee+woc.add_insurance_fee-woc.coupon_offset_fee),0)
        as totalIncome,
        woc.wl_pay_time as receivedTime,
        woc.finish_time
        from w_order_car woc
        left join w_order wo on woc.order_no = wo.no
        left join c_customer cc on wo.customer_id = cc.id
        LEFT JOIN c_customer_partner ccp on cc.id = ccp.customer_id
        left join w_waybill_car wwc on woc.id = wwc.order_car_id
        left join w_task_car wtc on wtc.waybill_car_id = wwc.id
        left join w_task wt on wtc.task_id = wt.id
        left join s_city zc on zc.code = wo.start_province_code
        left join s_city zcity on zcity.code = zc.parent_code
        where wo.state=100 and wo.customer_type=3
        <include refid="financeListCondition"></include>
        group by woc.no
        ) t order by t.finish_time desc
    </select>

    <select id="getFee" parameterType="map" resultType="java.math.BigDecimal">
        select IFNULL(sum(wwc.freight_fee),0)

        from w_waybill_car wwc
        left join w_waybill ww on wwc.waybill_no = ww.no
        left join d_carrier dc on ww.carrier_id = dc.id
        where wwc.order_car_no = #{orderCarNo} and ww.type = #{type}
        and wwc.state = 100 and ww.carrier_type in (1,2,4,5)
        order by ww.create_time desc
    </select>

    <select id="getTrunkCostList" parameterType="map" resultType="com.cjyc.common.model.vo.web.finance.TrunkLineVo">
        select ww.no as wayBillNo,
        ww.carrier_name as name,
        wwc.freight_fee as freightFee,
        if(ww.freight_pay_state=1,wwc.freight_fee,0) as paidFreightFee,
        ww.freight_pay_time as payTime,
        dc.settle_type as settleType,
        (CASE
            when ww.freight_pay_state=2 then '付款中'
            when ww.freight_pay_state=1 then '已付款'
            when ww.freight_pay_state=0 then '未付款'
            when ww.freight_pay_state=-2 then '支付失败'
        END) as payState,
        (CASE
            when dc.type=1 then '个人司机'
            when dc.type=2 then '承运商'
        END) as carrierType,
        dc.linkman_phone as phone,
        wwc.start_city as pickUpPlace,
        wwc.end_city as deliveryPlace

        from w_waybill_car wwc
        left join w_waybill ww on wwc.waybill_no = ww.no
        left join d_carrier dc on ww.carrier_id = dc.id
        where wwc.order_car_no = #{orderCarNo} and ww.type = #{type}
        and wwc.state = 100 and ww.carrier_type in (1,2,4,5)
        order by ww.create_time desc
    </select>

    <select id="getFinanceReceiptList" parameterType="com.cjyc.common.model.dto.web.finance.FinanceQueryDto"
            resultType="com.cjyc.common.model.vo.web.finance.FinanceReceiptVo">
        select woc.no,woc.vin,woc.brand,woc.model,cc.id,cc.type,
        cc.pay_mode as payMode,
        if(cc.pay_mode=0,'时付','账期') as payModeName,
        wwc.freight_fee as freightReceivable,
        wo.start_province,wo.start_city,
        wo.start_area,wo.end_province,wo.end_city,wo.end_area,
        woc.order_no,woc.now_area_code,wo.input_store_id,
        wo.input_store_name,wt.complete_time,
        cc.contact_phone as contactPhone,
        wo.customer_name as customerName
        from w_order_car woc
        left join w_order wo on woc.order_id = wo.id
        left join c_customer cc on cc.id = wo.customer_id
        left join w_waybill_car wwc on wwc.order_car_no = woc.no
        left join w_task wt on wt.waybill_no = wwc.waybill_no

        where cc.pay_mode=1
        <if test="no != null and no.trim() != ''">
            and woc.no like concat('%',#{no},'%')
        </if>
        <if test="vin != null and vin.trim() != ''">
            and woc.vin = #{vin}
        </if>
        <if test="orderNo != null and orderNo.trim() != ''">
            and woc.order_no like concat('%',#{orderNo},'%')
        </if>
        <if test="completeStartTime!= null">
            and wt.complete_time &gt;= #{completeStartTime}
        </if>
        <if test="completeEndTime!= null">
            and wt.complete_time &lt;= #{completeEndTime}
        </if>

        <if test="startProvinceCode != null and startProvinceCode.trim() != ''">
            and wo.start_province_code = #{startProvinceCode}
        </if>
        <if test="startCityCode != null and startCityCode.trim() != ''">
            and wo.start_city_code = #{startCityCode}
        </if>
        <if test="startAreaCode != null and startAreaCode.trim() != ''">
            and wo.start_area_code = #{startAreaCode}
        </if>
        <if test="endProvinceCode != null and endProvinceCode.trim() != ''">
            and wo.end_province_code = #{endProvinceCode}
        </if>
        <if test="endCityCode != null and endCityCode.trim() != ''">
            and wo.end_city_code = #{endCityCode}
        </if>
        <if test="endAreaCode != null and endAreaCode.trim() != ''">
            and wo.end_area_code = #{endAreaCode}
        </if>

        <if test="type != null">
            and cc.type = #{type}
        </if>
        <if test="customerName != null  and customerName.trim() != ''">
            and cc.name like concat('%',#{customerName},'%')
        </if>
        <if test="payMode != null">
            and cc.pay_mode =#{payMode}
        </if>

        <if test="brand != null and brand.trim() != ''">
            and cc.brand = #{brand}
        </if>
        <if test="model != null and model.trim() != ''">
            and cc.model = #{model}
        </if>
        <if test="inputStoreName != null and inputStoreName.trim() != ''">
            and wo.input_store_name = #{inputStoreName}
        </if>

        order by wo.create_time desc
    </select>

    <sql id="payMentListCondition">
        <if test="no != null and no.trim() != ''">
            and woc.no like concat('%',#{no},'%')
        </if>
        <if test="vin != null and vin.trim() != ''">
            and woc.vin = #{vin}
        </if>
        <if test="orderNo != null and orderNo.trim() != ''">
            and woc.order_no like concat('%',#{orderNo},'%')
        </if>
        <if test="area != null and area.trim() != ''">
            and zcity.code = #{area}
        </if>

        <if test="type != null">
            and cc.type = #{type}
        </if>
        <if test="customerName != null  and customerName.trim() != ''">
            and cc.name like concat('%',#{customerName},'%')
        </if>
        <if test="brand != null and brand.trim() != ''">
            and woc.brand = #{brand}
        </if>
        <if test="model != null and model.trim() != ''">
            and woc.model = #{model}
        </if>
        <if test="inputStoreName != null and inputStoreName.trim() != ''">
            and wo.input_store_name = #{inputStoreName}
        </if>
        <if test="completeStartTime!= null">
            and woc.finish_time &gt;= #{completeStartTime}
        </if>
        <if test="completeEndTime!= null">
            and woc.finish_time &lt;= #{completeEndTime}
        </if>
        <if test="startProvinceCode != null and startProvinceCode.trim() != ''">
            and wo.start_province_code = #{startProvinceCode}
        </if>
        <if test="startCityCode != null and startCityCode.trim() != ''">
            and wo.start_city_code = #{startCityCode}
        </if>
        <if test="startAreaCode != null and startAreaCode.trim() != ''">
            and wo.start_area_code = #{startAreaCode}
        </if>
        <if test="endProvinceCode != null and endProvinceCode.trim() != ''">
            and wo.end_province_code = #{endProvinceCode}
        </if>
        <if test="endCityCode != null and endCityCode.trim() != ''">
            and wo.end_city_code = #{endCityCode}
        </if>
        <if test="endAreaCode != null and endAreaCode.trim() != ''">
            and wo.end_area_code = #{endAreaCode}
        </if>
    </sql>
    <sql id="payMentListHeader">
        select DISTINCT(woc.no),woc.vin,woc.brand,woc.model,
        wo.customer_id as customerId,wo.customer_type as type,zcity.name as largeArea,
        '时付' as payModeName,woc.total_fee as freightReceivable,
        if(woc.wl_pay_state=2,woc.total_fee,0) as freightPay,
        if(woc.wl_pay_state=2,(woc.pick_fee+woc.trunk_fee+woc.back_fee+woc.add_insurance_fee-woc.coupon_offset_fee),0) as totalIncome,
        woc.order_no as orderNo,
        wo.start_province,wo.start_city,
        wo.start_city as startAddress,
        wo.end_city as endAddress,
        woc.now_area_code,wo.input_store_id,
        wo.input_store_name as inputStoreName,
        wo.customer_name as customerName,
        wo.customer_contract_id as customerContractId,
        woc.finish_time as deliveryDate,woc.finish_time,
        woc.wl_pay_time as payTime
        from w_order_car woc
        left join w_order wo on woc.order_id = wo.id
        left join c_customer cc on cc.id = wo.customer_id
    </sql>

    <select id="getPaymentList" parameterType="com.cjyc.common.model.dto.web.finance.FinanceQueryDto"
            resultType="com.cjyc.common.model.vo.web.finance.PaymentVo">
        select * from
        (
        <include refid="payMentListHeader"></include>
        left join w_waybill_car wwc on wwc.order_car_no = woc.no
        left join w_task wt on wt.waybill_no = wwc.waybill_no
        left join s_city zc on zc.code = wo.start_province_code
        left join s_city zcity on zcity.code = zc.parent_code

        where cc.pay_mode=0 and wo.customer_type=1 and wo.state=100
        <include refid="payMentListCondition"></include>
        <if test="payMode != null">
            and cc.pay_mode =#{payMode}
        </if>

        group by woc.no
        /*order by woc.finish_time desc*/
        union
        <include refid="payMentListHeader"></include>
        left join c_customer_partner ccp on cc.id = ccp.customer_id
        left join w_waybill_car wwc on wwc.order_car_no = woc.no
        left join w_task wt on wt.waybill_no = wwc.waybill_no
        left join s_city zc on zc.code = wo.start_province_code
        left join s_city zcity on zcity.code = zc.parent_code

        where ccp.settle_type=0 and wo.customer_type=3 and wo.state=100
        <include refid="payMentListCondition"></include>
        <if test="payMode != null">
            and ccp.settle_type =#{payMode}
        </if>
        group by woc.no
        union
        <include refid="payMentListHeader"></include>
        left join c_customer_contract ccc on cc.id =ccc.customer_id and ccc.id = wo.customer_contract_id
        left join w_waybill_car wwc on wwc.order_car_no = woc.no
        left join w_task wt on wt.waybill_no = wwc.waybill_no
        left join s_city zc on zc.code = wo.start_province_code
        left join s_city zcity on zcity.code = zc.parent_code

        where ccc.settle_type=0 and wo.customer_type=2 and wo.state=100
        <include refid="payMentListCondition"></include>
        <if test="payMode != null">
            and ccc.settle_type =#{payMode}
        </if>
        group by woc.no ) t order by t.finish_time desc
    </select>

    <select id="getAdvancePayment" resultType="com.cjyc.common.model.vo.web.finance.AdvancePaymentVo">
        select woc.no,woc.vin,woc.brand,woc.model,woc.total_fee as freightReceivable,
        if(woc.wl_pay_state=2,woc.total_fee,0) as freightPay,
        woc.order_no as orderNo,
        if(woc.wl_pay_state=2,woc.wl_pay_time,0) as payTime,
        wo.start_city as startCity,
        wo.end_city as endCity,
        wo.customer_type as type,
        wo.customer_name as customerName,
        wo.pay_type as payType
        from w_order_car woc
        left join w_order wo on wo.id= woc.order_id
        where (wo.state&lt;100 or wo.state=113) and woc.wl_pay_state=2 and wo.pay_type=1
        <if test="no != null and no.trim() != ''">
            and woc.no like concat('%',#{no},'%')
        </if>
        <if test="vin != null and vin.trim() != ''">
            and woc.vin = #{vin}
        </if>
        <if test="orderNo != null and orderNo.trim() != ''">
            and woc.order_no like concat('%',#{orderNo},'%')
        </if>
        <if test="payType != null">
            and wo.pay_type = #{payType}
        </if>
        union

        select woc.no,woc.vin,woc.brand,woc.model,woc.total_fee as freightReceivable,
        if(woc.wl_pay_state=2,woc.total_fee,0) as freightPay,
        woc.order_no as orderNo,
        if(woc.wl_pay_state=2,woc.wl_pay_time,0) as payTime,
        wo.start_city as startCity,
        wo.end_city as endCity,
        wo.customer_type as type,
        wo.customer_name as customerName,
        wo.pay_type as payType
        from w_order_car woc
        left join w_order wo on wo.id= woc.order_id
        where (wo.state&lt;100 or wo.state=113) and wo.pay_type=0
        <if test="no != null and no.trim() != ''">
            and woc.no like concat('%',#{no},'%')
        </if>
        <if test="vin != null and vin.trim() != ''">
            and woc.vin = #{vin}
        </if>
        <if test="orderNo != null and orderNo.trim() != ''">
            and woc.order_no like concat('%',#{orderNo},'%')
        </if>
        <if test="payType != null">
            and wo.pay_type = #{payType}
        </if>
        order by payTime desc
    </select>


    <select id="getCustomerContractById" parameterType="java.lang.Long" resultType="java.lang.Integer">
        select settle_type from c_customer_contract where id =#{customerContractId}
    </select>
    <select id="getCustomerPartnerById" parameterType="java.lang.Long" resultType="java.lang.Integer">
        select settle_type from c_customer_partner where customer_id =#{customerId}
    </select>

    <select id="getPaidList" parameterType="com.cjyc.common.model.dto.web.finance.PayMentQueryDto"
            resultType="com.cjyc.common.model.vo.web.finance.PaidVo">
        select ww.no as waybillNo,ww.complete_time as completeTime,
        ww.freight_fee as freightFee,ww.type,
        if(dc.settle_type=0,'时付','账期') as settleType,
        ww.guide_line as guideLine,ww.carrier_id,
        ww.carrier_name as carrierName,
        wt.driver_name as driverName,
        wt.driver_phone as driverPhone,
        wt.vehicle_plate_no as vehiclePlateNo
        from w_waybill ww
        left join d_carrier dc on dc.id=ww.carrier_id
        left join w_task wt on wt.waybill_id = ww.id
        where dc.settle_type=0 and ww.freight_pay_state=1
        <if test="waybillNo != null and waybillNo.trim() != ''">
            and ww.no like concat('%',#{waybillNo},'%')
        </if>
        <if test="completeStartTime!= null">
            and ww.complete_time &gt;= #{completeStartTime}
        </if>
        <if test="completeEndTime!= null">
            and ww.complete_time &lt;= #{completeEndTime}
        </if>
        <if test="waybillType!= null">
            and ww.type =#{waybillType}
        </if>
        <if test="invoiceNo!= null and invoiceNo.trim() != ''">
        </if>
        <if test="carrierName!= null and carrierName.trim() != ''">
            and ww.carrier_name like concat('%',#{carrierName},'%')
        </if>
        <if test="driverName!= null and driverName.trim() != ''">
            and wt.driver_name like concat('%',#{driverName},'%')
        </if>
        <if test="driverPhone!= null and driverPhone.trim() != ''">
            and wt.driver_phone like concat('%',#{driverPhone},'%')
        </if>
        <if test="vehiclePlateNo!= null and vehiclePlateNo.trim() != ''">
            and wt.vehicle_plate_no like concat('%',#{vehiclePlateNo},'%')
        </if>

        order by ww.create_time desc
    </select>

    <select id="getPaidListNew" parameterType="com.cjyc.common.model.dto.web.finance.PayMentQueryDto"
            resultType="com.cjyc.common.model.vo.web.finance.PaidNewVo">
        select ww.id as waybillId,ww.no as waybillNo,ww.complete_time as completeTime,
        ww.freight_fee as freightFee,ww.type,
        if(dc.settle_type=0,'时付','账期') as settleType,
        ww.guide_line as guideLine,ww.carrier_id,
        ww.carrier_name as carrierName,
        wt.driver_name as driverName,
        wt.driver_phone as driverPhone,
        wt.vehicle_plate_no as vehiclePlateNo,
        if(fep.state=0,'未付款','已付款') as state,
        fep.operator
        from f_external_payment fep
        left join w_waybill ww on fep.waybill_id = ww.id
        left join d_carrier dc on dc.id=ww.carrier_id
        left join w_task wt on wt.waybill_id = ww.id
        where dc.settle_type=0
        <if test="waybillNo != null and waybillNo.trim() != ''">
            and ww.no like concat('%',#{waybillNo},'%')
        </if>
        <if test="completeStartTime!= null">
            and ww.complete_time &gt;= #{completeStartTime}
        </if>
        <if test="completeEndTime!= null">
            and ww.complete_time &lt;= #{completeEndTime}
        </if>
        <if test="waybillType!= null">
            and ww.type =#{waybillType}
        </if>
        <if test="state!= null">
            and fep.state =#{state}
        </if>
        <if test="invoiceNo!= null and invoiceNo.trim() != ''">
        </if>
        <if test="carrierName!= null and carrierName.trim() != ''">
            and ww.carrier_name like concat('%',#{carrierName},'%')
        </if>
        <if test="driverName!= null and driverName.trim() != ''">
            and wt.driver_name like concat('%',#{driverName},'%')
        </if>
        <if test="driverPhone!= null and driverPhone.trim() != ''">
            and wt.driver_phone like concat('%',#{driverPhone},'%')
        </if>
        <if test="vehiclePlateNo!= null and vehiclePlateNo.trim() != ''">
            and wt.vehicle_plate_no like concat('%',#{vehiclePlateNo},'%')
        </if>
        <if test="operator!= null and operator.trim() != ''">
            and fep.operator like concat('%',#{operator},'%')
        </if>

        order by ww.create_time desc
    </select>

    <select id="getAutoPaidList" parameterType="com.cjyc.common.model.dto.web.finance.PayMentQueryDto"
            resultType="com.cjyc.common.model.vo.web.finance.PaidNewVo">
        select DISTINCT(ww.id) as waybillId,ww.no as waybillNo,ww.complete_time as completeTime,
        ww.freight_fee as freightFee,ww.type,
        if(ww.freight_pay_state=1,ftb.amount,0) as freightFeePayable,
        if(dc.settle_type=0,'时付','账期') as settleType,
        ww.guide_line as guideLine,ww.carrier_id,
        ww.carrier_name as carrierName,
        wt.driver_name as driverName,
        wt.driver_phone as driverPhone,
        (
        case
        when ww.freight_pay_state=0 then '未付款'
        when ww.freight_pay_state=1 then '已付款'
        when ww.freight_pay_state=2 then '正在支付'
        when ww.freight_pay_state=-1 then '支付失败'
        when ww.freight_pay_state=-2 then '支付失败'
        end
        ) as state,
        wt.vehicle_plate_no as vehiclePlateNo,
        sbcb.card_name as cardName,
        sbcb.card_no as cardNo,
        sbcb.bank_name as bankName,
        fep.operator,
        ww.freight_pay_time as payTime,
        sbcb.card_type as cardType,
        sbcb.id_card as idCard,
        sbcb.province_name as provinceName,
        sbcb.area_name as areaName
        from w_waybill ww
        left join d_carrier dc on dc.id=ww.carrier_id
        left join w_task wt on wt.waybill_id = ww.id
        left join f_external_payment fep on fep.waybill_id=ww.id
        left join s_bank_card_bind sbcb on sbcb.user_id = ww.carrier_id
        left join f_trade_bill_detail ftbd on ftbd.source_no = ww.id
        left join f_trade_bill ftb on ftb.id=ftbd.trade_bill_id
        where dc.settle_type=0 and ww.state=100 and wt.state &lt;= 100
        and ww.carrier_type in (1,2,4,5)
        <if test="waybillNo != null and waybillNo.trim() != ''">
            and ww.no like concat('%',#{waybillNo},'%')
        </if>
        <if test="completeStartTime!= null">
            and ww.complete_time &gt;= #{completeStartTime}
        </if>
        <if test="completeEndTime!= null">
            and ww.complete_time &lt;= #{completeEndTime}
        </if>
        <if test="waybillType!= null">
            and ww.type =#{waybillType}
        </if>
        <if test="invoiceNo!= null and invoiceNo.trim() != ''">
        </if>
        <if test="state!= null">
            and ww.freight_pay_state =#{state}
        </if>
        <if test="carrierName!= null and carrierName.trim() != ''">
            and ww.carrier_name like concat('%',#{carrierName},'%')
        </if>
        <if test="driverName!= null and driverName.trim() != ''">
            and wt.driver_name like concat('%',#{driverName},'%')
        </if>
        <if test="driverPhone!= null and driverPhone.trim() != ''">
            and wt.driver_phone like concat('%',#{driverPhone},'%')
        </if>
        <if test="vehiclePlateNo!= null and vehiclePlateNo.trim() != ''">
            and wt.vehicle_plate_no like concat('%',#{vehiclePlateNo},'%')
        </if>
        <if test="operator!= null and operator.trim() != ''">
            and fep.operator like concat('%',#{operator},'%')
        </if>
        order by ww.complete_time desc
    </select>

    <select id="getCollectReceiveList" parameterType="com.cjyc.common.model.dto.web.finance.CollectReceiveQueryDto"
            resultType="com.cjyc.common.model.vo.web.finance.CollectReceiveVo">
        select ww.no as wayBillNo,ww.type as wayBillType
        from w_waybill ww

        <where>
            <if test="wayBillNo != null and wayBillNo.trim() != ''">
                and ww.no like concat('%',#{wayBillNo},'%')
            </if>
            <if test="wayBillType!= null">
                and ww.type = #{wayBillType}
            </if>
            <!--<if test="collectMan !=null and collectMan.trim() !=''">

            </if>
            <if test="collectManPhone !=null and collectManPhone.trim() !=''">

            </if>
            <if test="returnStatus !=null and returnStatus.trim() !=''">

            </if>-->
        </where>

    </select>


    <!--应付 -->
    <select id="getFinancePayableList" parameterType="com.cjyc.common.model.dto.web.finance.PayableQueryDto"
            resultType="com.cjyc.common.model.vo.web.finance.FinancePayableVo">
        select
        wt.no,wt.complete_time as completeTime,
        ww.type as waybillType,
        ww.carrier_id as carrierId,
        ww.carrier_type as carrierType,
        ww.carrier_name as carrierName,
        wt.driver_id as driverId,
        wt.driver_name as driverName,
        wt.driver_phone as driverPhone,
        wt.vehicle_plate_no as vehiclePlateNo,
        if(dc.settle_type=0,'时付','账期') as settleTypeName,
        wt.car_num as carNum,
        dc.settle_period as settlePeriod
        from w_task wt
        left join w_waybill ww on ww.no = wt.waybill_no
        left join d_carrier dc on dc.id = ww.carrier_id
        where dc.settle_type = 1
        and wt.complete_time &gt; 0
        and carrier_type in (1,2,4,5)
        and wt.no not in (select IFNULL(fpd.no,'') from f_payable_detail fpd)
        and ww.state=100
        <if test="waybillNo !=null and waybillNo.trim() !=''">
            and wt.no like concat('%',#{waybillNo},'%')
        </if>
        <if test="carrierName !=null and carrierName.trim() !=''">
            and ww.carrier_name like concat('%',#{carrierName},'%')
        </if>
        <if test="driverName !=null and driverName.trim() !=''">
            and wt.driver_name like concat('%',#{driverName},'%')
        </if>
        <if test="completeStartTime !=null ">
            and wt.complete_time &gt;=#{completeStartTime}
        </if>
        <if test="completeEndTime !=null ">
            and wt.complete_time &lt;=#{completeEndTime}
        </if>
        <if test="driverPhone !=null and driverPhone.trim() !=''">
            and wt.driver_phone like concat('%',#{driverPhone},'%')
        </if>
        <if test="vehiclePlateNo !=null and vehiclePlateNo.trim() !=''">
            and wt.vehicle_plate_no like concat('%',#{vehiclePlateNo},'%')
        </if>
        <if test="waybillType !=null">
            and ww.type = #{waybillType}
        </if>
        order by wt.complete_time desc
    </select>

    <select id="getSettlementInfo" parameterType="java.util.List"
            resultType="com.cjyc.common.model.vo.web.finance.PayableTaskVo">
        select wt.no,wt.car_num as carNum,ww.type,wwc.freight_fee as freightFee
        from w_task wt
        left join w_task_car wtc on wt.id=wtc.task_id
        left join w_waybill_car wwc on wwc.id = wtc.waybill_car_id
        left join w_waybill ww on ww.no = wt.waybill_no
        where wt.no in
        <foreach collection="taskNoList" index="index" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

    <insert id="apply" parameterType="com.cjyc.common.model.vo.web.finance.SettlementVo">
        insert into f_payable(serial_number,freight_fee,apply_time,applicant_id,state)
        values (#{serialNumber},#{freightFee},#{applyTime},#{applicantId},#{state})
    </insert>

    <insert id="applyDetail" parameterType="com.cjyc.common.model.vo.web.finance.SettlementVo">
        insert into f_payable_detail(serial_number,no)
        values (#{serialNumber},#{no})
    </insert>

    <select id="getCollectTicketList" parameterType="com.cjyc.common.model.dto.web.finance.WaitTicketCollectDto"
            resultType="com.cjyc.common.model.vo.web.finance.SettlementVo">
        select
        fp.invoice_no as invoiceNo,
        fp.serial_number as serialNumber,
        fp.freight_fee as freightFee,
        fp.apply_time as applyTime,
        fp.applicant_id as applicantId,
        ba.name as applicant
        from f_payable fp
        left join b_admin ba on ba.id = fp.applicant_id
        where fp.state='0'
        <if test="serialNumber !=null and serialNumber.trim() !=''">
            and fp.serial_number like concat('%',#{serialNumber},'%')
        </if>
        <if test="applyStartTime !=null">
            and fp.apply_time &gt;=#{applyStartTime}
        </if>
        <if test="applyEndTime !=null">
            and fp.apply_time &lt;=#{applyEndTime}
        </if>
        <if test="applicant !=null and applicant.trim() !=''">
            and ba.name like concat('%',#{applicant},'%')
        </if>

        order by fp.apply_time desc
    </select>

    <select id="getTaskNoList" resultType="java.lang.String">
        select no from f_payable_detail where serial_number=#{serialNumber}
    </select>

    <update id="confirm" parameterType="com.cjyc.common.model.vo.web.finance.SettlementVo">
        update f_payable set state=#{state},confirm_id=#{confirmId},invoice_no=#{invoiceNo},
        confirm_time=#{confirmTime} where serial_number = #{serialNumber}
    </update>

    <delete id="withdraw" parameterType="String">
        delete fp,fpd
        from f_payable fp
        left join f_payable_detail fpd on fp.serial_number = fpd.serial_number
        where fp.serial_number=#{serialNumber}
    </delete>

    <select id="getPayablePaymentList" parameterType="com.cjyc.common.model.dto.web.finance.WaitPaymentDto"
            resultType="com.cjyc.common.model.vo.web.finance.SettlementVo">
        select fp.serial_number as serialNumber,
        fp.freight_fee as freightFee,
        fp.invoice_no as invoiceNo,
        fp.apply_time as applyTime,
        fp.applicant_id as applicantId,
        fp.confirm_id as confirmId,
        fp.confirm_time as confirmTime,
        ba.name as applicant,
        bc.name as confirmMan
        from f_payable fp
        left join b_admin ba on ba.id = fp.applicant_id
        left join b_admin bc on bc.id = fp.confirm_id
        where fp.state='1'
        <if test="serialNumber !=null and serialNumber.trim() !=''">
            and fp.serial_number like concat('%',#{serialNumber},'%')
        </if>
        <if test="applyStartTime !=null">
            and fp.apply_time &gt;=#{applyStartTime}
        </if>
        <if test="applyEndTime !=null">
            and fp.apply_time &lt;=#{applyEndTime}
        </if>
        <if test="applicant !=null and applicant.trim() !=''">
            and ba.name like concat('%',#{applicant},'%')
        </if>

        <if test="confirmStartTime !=null">
            and fp.confirm_time &gt;=#{confirmStartTime}
        </if>
        <if test="confirmEndTime !=null">
            and fp.confirm_time &lt;=#{confirmEndTime}
        </if>
        <if test="confirmMan !=null and confirmMan.trim() !=''">
            and ba.name like concat('%',#{confirmMan},'%')
        </if>
        <if test="invoiceNo !=null and invoiceNo.trim!=''">
            and fp.invoice_no like concat('%',#{invoiceNo},'%')
        </if>

        order by fp.confirm_time desc
    </select>

    <select id="getPayableSettlement" resultType="com.cjyc.common.model.vo.web.finance.SettlementVo">
        select invoice_no as invoiceNo,total_freight_paid as totalFreightPay,
        writeoff_time as writeoffTime, freight_fee as freightFee
        from f_payable where serial_number=#{serialNumber}
    </select>

    <update id="writeOffPayable" parameterType="com.cjyc.common.model.vo.web.finance.SettlementVo">
        update f_payable set state=#{state},writeoff_id=#{writeOffId},
        writeoff_time=#{writeOffTime}, total_freight_paid=#{totalFreightPay} where serial_number = #{serialNumber}
    </update>
    <select id="getPayablePaidList" parameterType="com.cjyc.common.model.dto.web.finance.PayablePaidQueryDto"
            resultType="com.cjyc.common.model.vo.web.finance.PayablePaidVo">
        select fp.serial_number as serialNumber,
        fp.freight_fee as freightFee,
        fp.invoice_no as invoiceNo,
        fp.apply_time as applyTime,
        fp.applicant_id as applicantId,
        fp.confirm_id as confirmId,
        fp.confirm_time as confirmTime,
        fp.writeoff_id as writeoffId,
        fp.writeoff_time as writeoffTime,
        fp.total_freight_paid as totalFreightPay,
        (fp.freight_fee-fp.total_freight_paid) as difference,
        ba.name as applicant,
        bc.name as confirmMan,
        bd.name as writeOffMan
        from f_payable fp
        left join b_admin ba on ba.id = fp.applicant_id
        left join b_admin bc on bc.id = fp.confirm_id
        left join b_admin bd on bd.id = fp.writeoff_id
        where fp.state='2'
        <if test="serialNumber !=null and serialNumber.trim() !=''">
            and fp.serial_number like concat('%',#{serialNumber},'%')
        </if>
        <if test="applyStartTime !=null">
            and fp.apply_time &gt;=#{applyStartTime}
        </if>
        <if test="applyEndTime !=null">
            and fp.apply_time &lt;=#{applyEndTime}
        </if>
        <if test="applicant !=null and applicant.trim() !=''">
            and ba.name like concat('%',#{applicant},'%')
        </if>

        <if test="confirmStartTime !=null">
            and fp.confirm_time &gt;=#{confirmStartTime}
        </if>
        <if test="confirmEndTime !=null">
            and fp.confirm_time &lt;=#{confirmEndTime}
        </if>
        <if test="confirmMan !=null and confirmMan.trim() !=''">
            and bc.name like concat('%',#{confirmMan},'%')
        </if>

        <if test="writeOffStartTime !=null">
            and fp.writeoff_time &gt;=#{writeOffStartTime}
        </if>
        <if test="writeOffEndTime !=null">
            and fp.writeoff_time &lt;=#{writeOffEndTime}
        </if>
        <if test="writeOffMan !=null and writeOffMan.trim() !=''">
            and bd.name like concat('%',#{writeOffMan},'%')
        </if>
        <if test="invoiceNo !=null and invoiceNo.trim!=''">
            and fp.invoice_no lifp.writeoff_timeke concat('%',#{invoiceNo},'%')
        </if>
        order by fp.writeoff_time desc
    </select>
    <select id="getCooperatorPaidList" parameterType="com.cjyc.common.model.dto.web.finance.CooperatorSearchDto"
            resultType="com.cjyc.common.model.vo.web.finance.CooperatorPaidVo">
        select wo.id as orderId,wo.no as orderNo,
        wo.customer_id as customerId,
        wo.customer_name as customerName,
        wo.customer_phone as customerPhone,
        (
        case
        when wo.flag=0 then '未付款'
        when wo.flag=1 then '付款中'
        when wo.flag=2 then '已付款'
        when wo.flag=-2 then '支付失败'
        end
        ) as state,
        if(wo.service_fee_pay_time>1582992000000,wo.service_fee_pay_time,null) as payTime,
        wo.start_city as startCity,
        wo.end_city as endCity,
        (
        case
        when wo.pay_type=0 then '到付'
        when wo.pay_type=1 then '预付'
        when wo.pay_type=2 then '账期'
        end
        ) as customerPayType,
        wo.wl_pay_time as wlPayTime,
        wo.total_fee as totalFee,
        wo.finish_time as completeTime,
        if(ccp.settle_type=0,'时付','账期') as settleType,
        if(sbcb.card_type=1,'公户','私户') as cardType,
        sbcb.bank_code,sbcb.bank_name as bankName,
        sbcb.card_name as cardName,
        sbcb.card_no as cardNo,
        sbcb.id_card as IDCard,
        fep.operator,
        sbcb.card_name as receiveCardName,
        sbcb.bank_name as bankNameDetail,
        sbcb.card_no as pubCardNo,
        sbcb.province_name as provinceName,
        sbcb.area_name as areaName
        from w_order wo
        left join s_bank_card_bind sbcb on wo.customer_id = sbcb.user_id
        left join c_customer_partner ccp on ccp.customer_id = wo.customer_id
        left join f_external_payment fep on fep.order_id=wo.id
        where wo.state=100 and wo.customer_type=3
        <if test="orderNo !=null and orderNo.trim() !=''">
            and wo.no like concat('%',#{orderNo},'%')
        </if>
        <!--付款开始时间-->
        <if test="startPayTime !=null">
            and wo.service_fee_pay_time &gt;=#{startPayTime}
        </if>
        <if test="endPayTime !=null">
            and wo.service_fee_pay_time &lt;=#{endPayTime}
        </if>
        <if test="startCompleteTime !=null">
            and wo.finish_time &gt;=#{startCompleteTime}
        </if>
        <if test="endCompleteTime !=null">
            and wo.finish_time &lt;=#{endCompleteTime}
        </if>
        <if test="state !=null and state.trim() !=''">
            and wo.flag = #{state}
        </if>
        <if test="phone !=null and phone.trim() !=''">
            and wo.customer_phone like concat('%',#{phone},'%')
        </if>
        <if test="customerName !=null and customerName.trim() !=''">
            and wo.customer_name like concat('%',#{customerName},'%')
        </if>
        <if test="operator !=null and operator.trim() !=''">
            and fep.operator like concat('%',#{operator},'%')
        </if>
        order by wo.finish_time desc
    </select>
    <select id="getFinanceDetailList" resultType="com.cjyc.common.model.vo.web.finance.ExportFinanceDetailVo">
        select DISTINCT(woc.no),woc.brand,woc.model,woc.vin,wo.input_store_name as inputStoreName,
        ww.no as wayBillNo,
        (CASE
                when ww.type=1 then '提车运单'
                when ww.type=2 then '干线运单'
                when ww.type=3 then '送车运单'
        END) as wayBillTypeName,
        if(dc.settle_type=0,'时付','账期') as settleType,
        wwc.freight_fee as freightFee,
        if(ww.freight_pay_state=1,wwc.freight_fee,0) as paidFreightFee,
        (CASE
            when ww.freight_pay_state=2 then '付款中'
            when ww.freight_pay_state=1 then '已付款'
            when ww.freight_pay_state=0 then '未付款'
            when ww.freight_pay_state=-2 then '支付失败'
        END) as payState,
        ww.freight_pay_time as payTime,
        ww.carrier_type as carrierType,
        (CASE
            when dc.type=1 then '个人司机'
            when dc.type=2 then '承运商'
        END) as carrierTypeStr,
        ww.carrier_name as carrierName,
        dc.linkman_phone as carrierPhone,
        wwc.start_city as pickUpPlace,
        wwc.end_city as deliveryPlace
        from w_order_car woc
        left join w_order wo on wo.id = woc.order_id
        LEFT JOIN w_waybill_car wwc on wwc.order_car_id = woc.id
        left join w_waybill ww on wwc.waybill_id = ww.id
        left join d_carrier dc on dc.id =ww.carrier_id
        left join f_trade_bill_detail ftbd on ftbd.source_no = ww.id
        left join f_trade_bill ftb on ftb.id = ftbd.trade_bill_id

        where ww.carrier_type in (1,2,4,5) and wwc.state=100 and woc.no =#{no}
    </select>
    <select id="payableAccountSummary" resultType="java.math.BigDecimal">
        select sum(wwc.freight_fee)
        from w_task wt
        left join w_task_car wtc on wt.id=wtc.task_id
        left join w_waybill_car wwc on wwc.id = wtc.waybill_car_id
        left join w_waybill ww on ww.no = wt.waybill_no
        where wt.no in(
        select wt.no
        from w_task wt
        left join w_waybill ww on ww.no = wt.waybill_no
        left join d_carrier dc on dc.id = ww.carrier_id
        where dc.settle_type = 1
        and wt.complete_time > 0
        and carrier_type in (1,2,4,5)
        and wt.no not in (select IFNULL(fpd.no,'') from f_payable_detail fpd)
        and ww.state=100
        <if test="waybillNo !=null and waybillNo.trim() !=''">
            and wt.no like concat('%',#{waybillNo},'%')
        </if>
        <if test="carrierName !=null and carrierName.trim() !=''">
            and ww.carrier_name like concat('%',#{carrierName},'%')
        </if>
        <if test="driverName !=null and driverName.trim() !=''">
            and wt.driver_name like concat('%',#{driverName},'%')
        </if>
        <if test="completeStartTime !=null ">
            and wt.complete_time &gt;=#{completeStartTime}
        </if>
        <if test="completeEndTime !=null ">
            and wt.complete_time &lt;=#{completeEndTime}
        </if>
        <if test="driverPhone !=null and driverPhone.trim() !=''">
            and wt.driver_phone like concat('%',#{driverPhone},'%')
        </if>
        <if test="vehiclePlateNo !=null and vehiclePlateNo.trim() !=''">
            and wt.vehicle_plate_no like concat('%',#{vehiclePlateNo},'%')
        </if>
        <if test="waybillType !=null">
            and ww.type = #{waybillType}
        </if>
        )
    </select>
    <select id="waitCollectSummary" resultType="java.math.BigDecimal">
        select sum(freightFee) from (select
        fp.invoice_no as invoiceNo,
        fp.serial_number as serialNumber,
        fp.freight_fee as freightFee,
        fp.apply_time as applyTime,
        fp.applicant_id as applicantId,
        ba.name as applicant
        from f_payable fp
        left join b_admin ba on ba.id = fp.applicant_id
        where fp.state='0'
        <if test="serialNumber !=null and serialNumber.trim() !=''">
            and fp.serial_number like concat('%',#{serialNumber},'%')
        </if>
        <if test="applyStartTime !=null">
            and fp.apply_time &gt;=#{applyStartTime}
        </if>
        <if test="applyEndTime !=null">
            and fp.apply_time &lt;=#{applyEndTime}
        </if>
        <if test="applicant !=null and applicant.trim() !=''">
            and ba.name like concat('%',#{applicant},'%')
        </if>) t
    </select>
    <select id="paymentSummary" resultType="java.math.BigDecimal">
        select sum(freightFee) from (
        select fp.serial_number as serialNumber,
        fp.freight_fee as freightFee,
        fp.invoice_no as invoiceNo,
        fp.apply_time as applyTime,
        fp.applicant_id as applicantId,
        fp.confirm_id as confirmId,
        fp.confirm_time as confirmTime,
        ba.name as applicant,
        bc.name as confirmMan
        from f_payable fp
        left join b_admin ba on ba.id = fp.applicant_id
        left join b_admin bc on bc.id = fp.confirm_id
        where fp.state='1'
        <if test="serialNumber !=null and serialNumber.trim() !=''">
            and fp.serial_number like concat('%',#{serialNumber},'%')
        </if>
        <if test="applyStartTime !=null">
            and fp.apply_time &gt;=#{applyStartTime}
        </if>
        <if test="applyEndTime !=null">
            and fp.apply_time &lt;=#{applyEndTime}
        </if>
        <if test="applicant !=null and applicant.trim() !=''">
            and ba.name like concat('%',#{applicant},'%')
        </if>

        <if test="confirmStartTime !=null">
            and fp.confirm_time &gt;=#{confirmStartTime}
        </if>
        <if test="confirmEndTime !=null">
            and fp.confirm_time &lt;=#{confirmEndTime}
        </if>
        <if test="confirmMan !=null and confirmMan.trim() !=''">
            and ba.name like concat('%',#{confirmMan},'%')
        </if>
        <if test="invoiceNo !=null and invoiceNo.trim!=''">
            and fp.invoice_no like concat('%',#{invoiceNo},'%')
        </if>) t
    </select>
    <select id="payablePaidSummary" resultType="java.util.Map">
        SELECT sum(freightFee) as freightFee,sum(totalFreightPay) as totalFreightPay from (select fp.serial_number as
        serialNumber,
        fp.freight_fee as freightFee,
        fp.invoice_no as invoiceNo,
        fp.apply_time as applyTime,
        fp.applicant_id as applicantId,
        fp.confirm_id as confirmId,
        fp.confirm_time as confirmTime,
        fp.writeoff_id as writeoffId,
        fp.writeoff_time as writeoffTime,
        fp.total_freight_paid as totalFreightPay,
        (fp.freight_fee-fp.total_freight_paid) as difference,
        ba.name as applicant,
        bc.name as confirmMan,
        bd.name as writeOffMan
        from f_payable fp
        left join b_admin ba on ba.id = fp.applicant_id
        left join b_admin bc on bc.id = fp.confirm_id
        left join b_admin bd on bd.id = fp.writeoff_id
        where fp.state='2'
        <if test="serialNumber !=null and serialNumber.trim() !=''">
            and fp.serial_number like concat('%',#{serialNumber},'%')
        </if>
        <if test="applyStartTime !=null">
            and fp.apply_time &gt;=#{applyStartTime}
        </if>
        <if test="applyEndTime !=null">
            and fp.apply_time &lt;=#{applyEndTime}
        </if>
        <if test="applicant !=null and applicant.trim() !=''">
            and ba.name like concat('%',#{applicant},'%')
        </if>

        <if test="confirmStartTime !=null">
            and fp.confirm_time &gt;=#{confirmStartTime}
        </if>
        <if test="confirmEndTime !=null">
            and fp.confirm_time &lt;=#{confirmEndTime}
        </if>
        <if test="confirmMan !=null and confirmMan.trim() !=''">
            and bc.name like concat('%',#{confirmMan},'%')
        </if>

        <if test="writeOffStartTime !=null">
            and fp.writeoff_time &gt;=#{writeOffStartTime}
        </if>
        <if test="writeOffEndTime !=null">
            and fp.writeoff_time &lt;=#{writeOffEndTime}
        </if>
        <if test="writeOffMan !=null and writeOffMan.trim() !=''">
            and bd.name like concat('%',#{writeOffMan},'%')
        </if>
        <if test="invoiceNo !=null and invoiceNo.trim!=''">
            and fp.invoice_no lifp.writeoff_timeke concat('%',#{invoiceNo},'%')
        </if>) t
    </select>
    <!--账期应收账款列表查询开始-->
    <!--账期应收账款列表查询公共sql-->
    <sql id="PAYMENT_DAYS_COMMON_SQL">
        SELECT DISTINCT(woc.no),woc.vin,woc.brand,woc.model,
        wo.customer_id AS customerId,wo.customer_type AS type,zcity.name AS largeArea,
        '账期' AS payModeName,woc.total_fee AS freightReceivable,
        if(woc.wl_pay_state=2,woc.total_fee,0) AS freightPay,
        woc.order_no AS orderNo,
        wo.start_province,wo.start_city,
        wo.start_city AS startAddress,
        wo.end_city AS endAddress,
        woc.now_area_code,wo.input_store_id,
        wo.input_store_name AS inputStoreName,
        wo.customer_name AS customerName,
        wo.customer_contract_id AS customerContractId,
        woc.finish_time AS deliveryDate,
        wo.finish_time AS orderDeliveryDate,
        woc.id AS orderCarId,
        ccc.settle_period,
        cc.contact_phone
        FROM w_order_car woc
        LEFT JOIN w_order wo ON woc.order_id = wo.id
        LEFT JOIN c_customer cc ON cc.id = wo.customer_id
    </sql>
    <!--账期应收账款列表查询条件sql-->
    <sql id="PAYMENT_DAYS_CONDITION">
        <if test="no != null and no.trim() != ''">
            AND woc.no LIKE concat('%',#{no},'%')
        </if>
        <if test="vin != null and vin.trim() != ''">
            AND woc.vin = #{vin}
        </if>
        <if test="orderNo != null and orderNo.trim() != ''">
            AND woc.order_no LIKE concat('%',#{orderNo},'%')
        </if>
        <if test="area != null and area.trim() != ''">
            AND zcity.code = #{area}
        </if>
        <if test="type != null">
            AND cc.type = #{type}
        </if>
        <if test="customerName != null  and customerName.trim() != ''">
            AND cc.name LIKE concat('%',#{customerName},'%')
        </if>
        <if test="contactPhone != null and contactPhone.trim() != ''">
            AND cc.contact_phone = #{contactPhone}
        </if>
        <if test="brand != null and brand.trim() != ''">
            AND woc.brand = #{brand}
        </if>
        <if test="model != null and model.trim() != ''">
            AND woc.model = #{model}
        </if>
        <if test="inputStoreName != null and inputStoreName.trim() != ''">
            AND wo.input_store_name = #{inputStoreName}
        </if>
        <if test="completeStartTime!= null">
            AND woc.finish_time &gt;= #{completeStartTime}
        </if>
        <if test="completeEndTime!= null">
            AND woc.finish_time &lt;= #{completeEndTime}
        </if>
        <if test="startProvinceCode != null and startProvinceCode.trim() != ''">
            AND wo.start_province_code = #{startProvinceCode}
        </if>
        <if test="startCityCode != null and startCityCode.trim() != ''">
            AND wo.start_city_code = #{startCityCode}
        </if>
        <if test="startAreaCode != null and startAreaCode.trim() != ''">
            AND wo.start_area_code = #{startAreaCode}
        </if>
        <if test="endProvinceCode != null and endProvinceCode.trim() != ''">
            AND wo.end_province_code = #{endProvinceCode}
        </if>
        <if test="endCityCode != null and endCityCode.trim() != ''">
            AND wo.end_city_code = #{endCityCode}
        </if>
        <if test="endAreaCode != null and endAreaCode.trim() != ''">
            AND wo.end_area_code = #{endAreaCode}
        </if>
    </sql>
    <!--账期应收账款列表查询sql-->
    <select id="listPaymentDaysInfo" resultType="com.cjyc.common.model.dto.web.finance.ReceiveOrderCarDto">
        <!--企业客户账期应收账款信息查询sql-->
        <include refid="PAYMENT_DAYS_COMMON_SQL"></include>
        LEFT JOIN c_customer_contract ccc ON cc.id =ccc.customer_id AND ccc.id = wo.customer_contract_id
        LEFT JOIN s_city zc ON zc.code = wo.start_province_code
        LEFT JOIN s_city zcity ON zcity.code = zc.parent_code
        WHERE
        <!--账期-->
        ccc.settle_type=1
        <!--企业大客户-->
        AND wo.customer_type=2
        <!--订单已交付-->
        AND wo.state=100
        <!--未申请结算-->
        AND woc.id NOT IN (SELECT IFNULL(rsd.order_car_id,'') FROM s_settlement_detail rsd)
        <include refid="PAYMENT_DAYS_CONDITION"></include>
        GROUP BY woc.no
        ORDER BY woc.finish_time DESC
    </select>
    <!--账期应收账款汇总sql-->
    <select id="receiptSummary" resultType="java.math.BigDecimal">
        SELECT sum(t.total_fee) FROM (
        SELECT DISTINCT(woc.no),woc.total_fee
        FROM w_order_car woc
        LEFT JOIN w_order wo ON woc.order_id = wo.id
        LEFT JOIN c_customer cc ON cc.id = wo.customer_id
        LEFT JOIN c_customer_contract ccc ON cc.id =ccc.customer_id AND ccc.id = wo.customer_contract_id
        LEFT JOIN s_city zc ON zc.code = wo.start_province_code
        LEFT JOIN s_city zcity ON zcity.code = zc.parent_code
        WHERE
        <!--账期-->
        ccc.settle_type=1
        <!--企业大客户-->
        AND wo.customer_type=2
        <!--订单已交付-->
        AND wo.state=100
        <!--未申请结算-->
        AND woc.id NOT IN (SELECT IFNULL(rsd.order_car_id,'') FROM s_settlement_detail rsd)
        <include refid="PAYMENT_DAYS_CONDITION"></include>
        GROUP BY woc.no ) t
    </select>
    <!--账期应收账款列表查询结束-->

    <!-- 账期开票金额 -->
    <select id="getSettlementDetail"
            resultType="com.cjyc.common.model.vo.web.finance.FinanceSettlementDetailVo">
        SELECT ssd.no,ssd.freight_receivable as freightFee,
        ssd.invoice_fee as invoiceFee,ss.verification_time as verificationTime
        FROM s_settlement_detail ssd
        LEFT JOIN s_settlement ss on ss.serial_number = ssd.serial_number
        WHERE no=#{no} and ss.state=3
    </select>
</mapper>