<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cjyc.common.model.dao.IOrderCarDao">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.cjyc.common.model.entity.OrderCar">
        <id column="id" property="id" />
        <result column="order_id" property="orderId" />
        <result column="order_no" property="orderNo" />
        <result column="no" property="no" />
        <result column="brand" property="brand" />
        <result column="model" property="model" />
        <result column="plate_no" property="plateNo" />
        <result column="vin" property="vin" />
        <result column="valuation" property="valuation" />
        <result column="now_store_id" property="nowStoreId" />
        <result column="now_area_code" property="nowAreaCode" />
        <result column="state" property="state" />
        <result column="description" property="description" />
        <result column="pick_fee" property="pickFee" />
        <result column="trunk_fee" property="trunkFee" />
        <result column="back_fee" property="backFee" />
        <result column="insurance_fee" property="insuranceFee" />
        <result column="insurance_coverage_amount" property="insuranceCoverageAmount" />
        <result column="agency_fee" property="agencyFee" />
        <result column="wl_pay_state" property="wlPayState" />
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, order_id, order_no, no, brand, model, plate_no, vin, valuation, now_store_id, now_area_code, state, description, pick_fee, trunk_fee, back_fee, insurance_fee, insurance_coverage_amount, agency_fee, wl_pay_state
    </sql>

    <!-- 通过订单编号查询车辆信息 -->
    <select id="getOrderCarByNo" resultType="com.cjyc.common.model.vo.customer.OrderCarCenterVo" parameterType="java.lang.String">
         select brand as brand ,model as model ,plate_no as plateNo,vin as vin from w_order_car where order_no = #{orderNo};
    </select>
    <!--按地级城市统计待调度车辆数量-->
    <select id="countListWaitDispatchCar" resultType="java.util.Map">
        select count(0) as car_num, start_city_code as cityCode, start_city as cityName from w_order o
        join w_order_car c on o.id = c.order_id
        where o.state BETWEEN 25 and 100
        and c.state &lt; 5
        group by o.start_city_code

        union
        select count(0) as car_num, start_city_code as cityCode, start_city as cityName from w_order o
        join w_order_car c on o.id = c.order_id
        where o.state BETWEEN 25 and 100
        and c.state = 25
        group by o.start_city_code

        union
        select count(0) as car_num, start_city_code as cityCode, start_city as cityName from w_order o
        join w_order_car c on o.id = c.order_id
        where o.state BETWEEN 25 and 100
        and c.state = 45
        group by o.start_city_code
    </select>

    <select id="countTotalWaitDispatchCar" resultType="java.util.Map">
        select sum(carNum) as totalCount from (
        select count(0) as carNum
        from w_order o
        join w_order_car c on o.id = c.order_id
        where o.state BETWEEN 25 and 100
        and c.state &lt; 5
        group by o.start_city_code

        union
        select count(0) as carNum
        from w_order o
        join w_order_car c on o.id = c.order_id
        where o.state BETWEEN 25 and 100
        and c.state = 25
        group by o.start_city_code

        union
        select count(0) as carNum
        from w_order o
        join w_order_car c on o.id = c.order_id
        where o.state BETWEEN 25 and 100
        and c.state = 45
        group by o.start_city_code
        ) as t
    </select>

    <!-- 通过主键查询车辆信息 -->
    <select id="getOrderCarInfoById" resultType="com.cjyc.common.model.vo.customer.OrderCarCenterVo" parameterType="java.lang.Long">
         select valuation as valuation,insurance_coverage_amount as insuredAmount,insurance_fee as insuranceFee,is_move as isMove, brand as brand ,model as model ,plate_no as plateNo,vin as vin from w_order_car where id = #{orderCarId};
    </select>

    <!-- 通过筛选条件查询车辆信息 -->
    <select id="getOrderCarInfoByTerm" resultType="com.cjyc.common.model.vo.customer.OrderCarCenterVo" parameterType="java.lang.String">
         select brand as brand ,model as model ,plate_no as plateNo,vin as vin from w_order_car
           <where>
               <if test="storeId != null and storeId != ''">
                   and  now_store_id = #{storeId}
               </if>
               <if test="brand != null and brand != ''">
                   and  brand = #{brand}
               </if>
               <if test="model != null and model != ''">
                   and  model = #{model}
               </if>
                   and order_no = #{orderNo}
           </where>

    </select>
    <!--查询待调度车辆列表-->
    <select id="findWaitDispatchCarList" resultType="com.cjyc.common.model.vo.web.order.OrderCarWaitDispatchVo">
        select
            c.id as id,
            c.order_id as orderId,
            c.order_no as orderNo,
            o.source as source,
            o.start_store_id as startStoreId,
            o.start_store_name as startStoreName,
            o.end_store_id as endStoreId,
            o.end_store_name as endStoreName,
            o.state as state,
            o.start_city as startCity,
            o.end_city as endCity,
            c.no as carNo,
            c.brand as brand,
            c.model as model,
            c.plate_no as plateNo,
            c.vin as vin,
            c.is_move as isMove,
            c.is_new as isNew,
            c.valuation as valuation,
            c.now_store_id as nowStoreId,
            c.now_area_code as nowAreaCode,
            c.description as description,
            c.pick_fee as pickFee,
            c.trunk_fee as trunkFee,
            c.back_fee as backFee,
            c.insurance_fee as insuranceFee,
            c.insurance_coverage_amount as insuranceCoverageAmount,
            c.agency_fee as agencyFee,
            c.total_fee as totalFee,
            c.wl_pay_state as wlPayState,
            o.create_time as createTime,
            o.create_user_name as createUserName,
            o.create_user_id as createUserId
        from w_order o
        join w_order_car c on c.order_id = o.id
        <where>
            <if test="paramsDto.startProvinceCode != null and paramsDto.startProvinceCode != ''" >
                and o.start_province_code = #{paramsDto.startProvinceCode,jdbcType=VARCHAR},
            </if>
            <if test="paramsDto.startCityCode != null and paramsDto.startCityCode != ''" >
                and o.start_city_code = #{paramsDto.startCityCode,jdbcType=VARCHAR},
            </if>
            <if test="paramsDto.startAreaCode != null and paramsDto.startAreaCode != ''" >
                and o.start_area_code = #{paramsDto.startAreaCode,jdbcType=VARCHAR},
            </if>
            <if test="paramsDto.startStoreId != null" >
                and o.start_store_id = #{paramsDto.startStoreId,jdbcType=BIGINT},
            </if>
            <if test="paramsDto.endProvinceCode != null and paramsDto.endProvinceCode != ''" >
                and o.end_province_code = #{paramsDto.endProvinceCode,jdbcType=VARCHAR},
            </if>
            <if test="paramsDto.endCityCode != null and paramsDto.endCityCode != ''" >
                and o.end_city_code = #{paramsDto.endCityCode,jdbcType=VARCHAR},
            </if>
            <if test="paramsDto.endAreaCode != null and paramsDto.endAreaCode != ''" >
                and o.end_area_code = #{paramsDto.endAreaCode,jdbcType=VARCHAR},
            </if>
            <if test="paramsDto.endStoreId != null" >
                and o.end_store_id = #{paramsDto.endStoreId,jdbcType=BIGINT},
            </if>
            <if test="paramsDto.orderNo != null and paramsDto.orderNo != ''" >
                and c.order_no = #{paramsDto.orderNo,jdbcType=VARCHAR},
            </if>
            <if test="paramsDto.carNo != null and paramsDto.carNo != ''" >
                and c.no = #{paramsDto.carNo,jdbcType=VARCHAR},
            </if>
            <if test="paramsDto.vin != null and paramsDto.vin != ''" >
                and c.vin = #{paramsDto.vin,jdbcType=VARCHAR},
            </if>

            <if test="paramsDto.beginExpectStartDate != null" >
                and o.expect_start_date &gt; #{paramsDto.beginExpectStartDate,jdbcType=BIGINT},
            </if>
            <if test="paramsDto.endExpectStartDate != null" >
                and o.expect_start_date &lt; #{paramsDto.endExpectStartDate,jdbcType=BIGINT},
            </if>

            <if test="paramsDto.pickType != null" >
                and o.pick_type = #{paramsDto.pickType,jdbcType=TINYINT},
            </if>
            <if test="paramsDto.pickContactName != null and paramsDto.pickContactName != ''" >
                and o.pick_contact_name = #{paramsDto.pickContactName,jdbcType=VARCHAR},
            </if>
            <if test="paramsDto.pickContactPhone != null and paramsDto.pickContactPhone != ''" >
                and o.pick_contact_phone = #{paramsDto.pickContactPhone,jdbcType=VARCHAR},
            </if>
            <if test="paramsDto.backType != null" >
                and o.back_type = #{paramsDto.backType,jdbcType=TINYINT},
            </if>
            <if test="paramsDto.backContactName != null and paramsDto.backContactName != ''" >
                and o.back_contact_name = #{paramsDto.backContactName,jdbcType=VARCHAR},
            </if>
            <if test="paramsDto.backContactPhone != null and paramsDto.backContactPhone != ''" >
                and o.back_contact_phone = #{paramsDto.backContactPhone,jdbcType=VARCHAR},
            </if>
            <if test="paramsDto.brand != null and paramsDto.brand != ''" >
                and c.brand = #{paramsDto.brand,jdbcType=VARCHAR},
            </if>
            <if test="paramsDto.model != null and paramsDto.model != ''" >
                and c.model = #{paramsDto.model,jdbcType=VARCHAR},
            </if>
            <if test="paramsDto.plateNo != null and paramsDto.plateNo != ''" >
                and c.plate_no = #{paramsDto.plateNo,jdbcType=VARCHAR},
            </if>
            <if test="paramsDto.startStoreId != null" >
                and o.start_store_id = #{paramsDto.startStoreId,jdbcType=BIGINT},
            </if>
            <if test="paramsDto.endStoreId != null" >
                and end_store_id = #{paramsDto.endStoreId,jdbcType=BIGINT},
            </if>
            <include refid="and_bizScopeStoreIds"/>
            <if test="bizScope != null">
                and now_store_id in

            </if>



        </where>

    </select>
    <!--按线路统计待调度车辆（统计列表）-->
    <select id="findlineWaitDispatchCarCountList" resultType="java.util.Map">


    </select>

    <!--业务范围条件-->
    <sql id="and_bizScopeStoreIds">
        <if test="bizScope != null">
            and now_store_id in
            <foreach collection="bizScope" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
    </sql>
</mapper>
