<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cjyc.common.model.dao.IWaybillDao">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.cjyc.common.model.entity.Waybill">
        <id column="id" property="id" />
        <result column="no" property="no" />
        <result column="type" property="type" />
        <result column="source" property="source" />
        <result column="guide_line" property="guideLine" />
        <result column="recommend_line" property="recommendLine" />
        <result column="carrier_id" property="carrierId" />
        <result column="carrier_type" property="carrierType" />
        <result column="carrier_name" property="carrierName" />
        <result column="car_num" property="carNum" />
        <result column="state" property="state" />
        <result column="freight_fee" property="freightFee" />
        <result column="freight_pay_state" property="freightPayState" />
        <result column="freight_pay_time" property="freightPayTime" />
        <result column="freight_pay_billno" property="freightPayBillno" />
        <result column="fixed_freight_fee" property="fixedFreightFee" />
        <result column="remark" property="remark" />
        <result column="create_time" property="createTime" />
        <result column="create_user" property="createUser" />
        <result column="create_user_id" property="createUserId" />
        <result column="input_store_id" property="inputStoreId" />
    </resultMap>
    <resultMap id="TrunkListResultMap" type="com.cjyc.common.model.vo.web.waybill.TrunkListWaybillVo">
        <id column="id" property="id" />
        <result column="no" property="no" />
        <result column="type" property="type" />
        <result column="source" property="source" />
        <result column="guide_line" property="guideLine" />
        <result column="recommend_line" property="recommendLine" />
        <result column="carrier_id" property="carrierId" />
        <result column="carrier_type" property="carrierType" />
        <result column="carrier_name" property="carrierName" />
        <result column="car_num" property="carNum" />
        <result column="state" property="state" />
        <result column="freight_fee" property="freightFee" />
        <result column="freight_pay_state" property="freightPayState" />
        <result column="freight_pay_time" property="freightPayTime" />
        <result column="freight_pay_billno" property="freightPayBillno" />
        <result column="fixed_freight_fee" property="fixedFreightFee" />
        <result column="remark" property="remark" />
        <result column="create_time" property="createTime" />
        <result column="create_user" property="createUser" />
        <result column="create_user_id" property="createUserId" />
        <result column="input_store_id" property="inputStoreId" />
        <collection property="child" ofType="com.cjyc.common.model.vo.web.waybill.TrunkListTaskVo" javaType="java.util.List">
            <id column="id" property="id" />
            <result column="no" property="no" />
            <result column="waybill_id" property="waybillId" />
            <result column="waybill_no" property="waybillNo" />
            <result column="car_num" property="carNum" />
            <result column="state" property="state" />
            <result column="driver_name" property="driverName" />
            <result column="driver_phone" property="driverPhone" />
            <result column="driver_id" property="driverId" />
            <result column="load_car_num" property="loadCarNum" />
            <result column="unload_car_num" property="unloadCarNum" />
            <result column="vehicle_running_id" property="vehicleRunningId" />
            <result column="vehicle_plate_no" property="vehiclePlateNo" />
            <result column="remark" property="remark" />
            <result column="create_user" property="createUser" />
            <result column="create_user_id" property="createUserId" />
            <result column="create_time" property="createTime" />
            <result column="carry_car_num" property="carryCarNum" />
            <result column="empty_car_num" property="emptyCarNum" />
            <result column="complete_time" property="completeTime" />
        </collection>
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, no, type, source, guide_line, recommend_line, carrier_id, carrier_type, carrier_name, car_num, state, freight_fee, freight_pay_state, freight_pay_time, freight_pay_billno, fixed_freight_fee, remark, create_time, create_user, create_user_id, input_store_id, complete_time
    </sql>

    <update id="updateStateBatchByNos">
        update w_waybill
        set state = #{state}
        <where>
            and state &lt; 15
            and no in
            <foreach collection="waybillNoList" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </where>

    </update>
    <update id="updateStateBatchByIds">
        update w_waybill
        set state = #{state}
        <where>
            and state &lt; 15
            and id in
            <foreach collection="waybillIdList" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </where>
    </update>
    <update id="updateStateById">
        update w_waybill
        set state = #{state}
        where state &lt; 100
        and id = #{waybillId}
    </update>
    <update id="updateForAllotDriver">
        update w_waybill
        set state = 55
        where id = #{waybillId} and state = 20
    </update>
    <update id="updateForReceipt">
        update w_waybill
        set state = 100,
        complete_time = #{currentTimeMillis}
        where id = #{waybillId}
        and state &lt; 100
    </update>
    <select id="findByNo" resultType="com.cjyc.common.model.entity.Waybill">
        select
        <include refid="Base_Column_List"/>
        from w_waybill
        where no = #{waybillNo}
    </select>
    <select id="findListByNos" resultType="com.cjyc.common.model.entity.Waybill">
        select
        <include refid="Base_Column_List"/>
        from w_waybill
        <where>
            no in
            <foreach collection="waybillNoList" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </where>
    </select>
    <select id="findListByIds" resultType="com.cjyc.common.model.entity.Waybill">
        select
        <include refid="Base_Column_List"/>
        from w_waybill
        <where>
            id in
            <foreach collection="waybillIdList" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </where>
    </select>
    <select id="findHistoryList" resultType="com.cjyc.common.model.vo.web.waybill.HistoryListWaybillVo">
        select
            w.type as type,
            wc.waybill_no as waybillNo,
            wc.start_city_code as startCityCode,
            wc.start_city_name as startCityName,
            wc.end_city_code as endCityCode,
            wc.end_city_name as endCityName,
            wc.start_address as startAddress,
            wc.end_address as endAddress,
            w.carrier_id as carrierId,
            w.carrier_name as carrierName,
            t.driver_id as driverId,
            t.driver_name as driverName,
            t.driver_phone as driverPhone,
            wc.pick_contact_name as pickContactName,
            wc.pick_contact_phone as pickContactPhone,
            wc.expect_start_time as expectStartTime,
            wc.expect_end_time as expectEndTime,
            tc.load_time as loadTime,
            tc.unload_time as unloadTime
        from w_order_car oc
        left join w_waybill_car wc on wc.order_car_id = oc.id
        left join w_waybill w on wc.waybill_id = w.id
        left join w_task_car tc on tc.waybill_car_id = wc.id
        left join w_task t on t.id = tc.task_id
        <where>
            wc.order_car_id = #{paramsDto.orderCarId}
            and w.type = #{paramsDto.type}
        </where>
    </select>
    <select id="findByOrderCarId" resultType="com.cjyc.common.model.entity.Waybill">
        select
        <include refid="Base_Column_List"/>
        from w_waybill_car wc
        join w_waybill w on wc.waybill_id = w.id
        where wc.order_car_id = 1
        GROUP BY w.id

    </select>
    <select id="findTrunkStateListByOrderCarId" resultType="java.lang.Integer">
        select
        w.state
        from w_waybill_car wc
        join w_waybill w on wc.waybill_id = w.id
        where wc.order_car_id = #{orderCarId}
        and w.type = 3
        and w.state &lt;= 100
        GROUP BY w.id
    </select>

    <select id="countWaybill" resultType="java.lang.Integer">
        select
        count(0)
        from w_waybill w
        join w_waybill_car wc on wc.waybill_id = w.id
        where w.state &lt;= 100
        and wc.order_car_id = #{orderCarId}
        and w.type = #{waybillType}
    </select>

    <select id="findListTrunk" resultMap="TrunkListResultMap">
        select
        w.*,
        t.*,
        vr.carry_car_num as carryCarNum,
        vr.occupied_car_num as occupiedCarNum
        from w_waybill w
        join w_task t on t.waybill_id = w.id
        left join d_vehicle_running vr on vr.id = t.vehicle_running_id
    </select>
    <select id="findLeftListTrunk" resultType="com.cjyc.common.model.vo.web.waybill.TrunkListWaybillVo">
         select
        w.*,
        t.*,
        vr.carry_car_num as carryCarNum,
        vr.occupied_car_num as occupiedCarNum
        from w_waybill w
        left join w_task t on t.waybill_id = w.id
        left join d_vehicle_running vr on vr.id = t.vehicle_running_id
    </select>


    <select id="findVoById" resultType="com.cjyc.common.model.vo.web.waybill.WaybillVo">
        select
            w.*,
            (case w.carrier_type
            when 1 then '个人司机'
            when 2 then w.carrier_name
            when 3 then '业务员'
            when 4 then '代驾'
            when 5 then '拖车'
            when 6 then '自提/自送'
            else null end) as carrier,
            (case when w.carrier_type != 2 then dr.id else null end) as driverId,
            (case when w.carrier_type != 2 then dr.name else null end) as driverName,
            (case when w.carrier_type != 2 then dr.phone else null end) as driverPhone,
            (case when w.carrier_type != 2 then dr.id_card else null end) as idCard,
            (case when w.carrier_type != 2 then vr.plate_no else null end) as vehiclePlateNo
        from w_waybill w
        LEFT JOIN w_task t on t.waybill_id = w.id
        LEFT JOIN d_driver dr on dr.id = t.driver_id
        left join d_vehicle_running vr on vr.driver_id = t.driver_id
        where w.id = #{id}
        group by w.id
    </select>
    <select id="findMainListTrunk" resultType="com.cjyc.common.model.vo.web.waybill.TrunkMainListWaybillVo">
        select
        w.*,
        (case when w.carrier_type != 2 then t.driver_id end) as driverId,
        (case when w.carrier_type != 2 then t.driver_name end) as driverName,
        (case when w.carrier_type != 2 then t.driver_phone end) as driverPhone,
        (case when w.carrier_type != 2 then vr.plate_no end) as vehiclePlateNo,
        (case when w.carrier_type != 2 then vr.carry_car_num end) as carryCarNum,
        (case when w.carrier_type != 2 then vr.occupied_car_num end) as occupiedCarNum
        from w_waybill w
        LEFT JOIN w_task t on w.id = t.waybill_id
        left join d_vehicle_running vr on vr.driver_id = t.driver_id
        <where>
            w.type = 2
            <if test="paramsDto.waybillNo != null and paramsDto.waybillNo != ''">
                and w.no  = #{paramsDto.waybillNo}
            </if>
            <if test="paramsDto.guideLine != null and paramsDto.guideLine != ''">
                and w.guide_line  = #{paramsDto.guideLine}
            </if>
            <if test="paramsDto.carrierName != null and paramsDto.carrierName != ''">
                and w.carrier_name  = #{paramsDto.carrierName}
            </if>
            <if test="paramsDto.beginCreateTime != null">
                and w.create_time  &gt; #{paramsDto.beginCreateTime}
            </if>
            <if test="paramsDto.endCreateTime != null">
                and w.create_time  &lt;= #{paramsDto.endCreateTime}
            </if>
        </where>
        group by w.id

    </select>
    <select id="findSubListTrunk" resultType="com.cjyc.common.model.vo.web.waybill.TrunkSubListWaybillVo">
        select
        w.*,
        t.no as taskNo,
        t.car_num as taskCarNum,
        (case when w.carrier_type = 1 then t.driver_id end) as driverId,
        (case when w.carrier_type = 1 then t.driver_name end) as driverName,
        (case when w.carrier_type = 1 then t.driver_phone end) as driverPhone,
        (case when w.carrier_type = 1 then vr.plate_no end) as plateNo,
        (case when w.carrier_type = 1 then vr.carry_car_num end) as carryCarNum,
        (case when w.carrier_type = 1 then vr.occupied_car_num end) as occupiedCarNum
        from w_waybill w
        JOIN w_task t on w.id = t.waybill_id
        left join d_vehicle_running vr on vr.driver_id = t.driver_id
        <where>
            w.type = 2
            <if test="paramsDto.waybillNo != null and paramsDto.waybillNo != ''">
                and w.no  = #{paramsDto.waybillNo}
            </if>
            <if test="paramsDto.guideLine != null and paramsDto.guideLine != ''">
                and w.guide_line  = #{paramsDto.guideLine}
            </if>
            <if test="paramsDto.carrierName != null and paramsDto.carrierName != ''">
                and w.carrier_name  = #{paramsDto.carrierName}
            </if>
            <if test="paramsDto.driverName != null and paramsDto.driverName != ''">
                and t.driver_name  = #{paramsDto.driverName}
            </if>
            <if test="paramsDto.driverPhone != null and paramsDto.driverPhone != ''">
                and t.driver_phone  = #{paramsDto.driverPhone}
            </if>
            <if test="paramsDto.vehiclePlateNo != null and paramsDto.vehiclePlateNo != ''">
                and t.vehicle_plate_no  = #{paramsDto.vehiclePlateNo}
            </if>
            <if test="paramsDto.beginCreateTime != null">
                and t.create_time  &gt; #{paramsDto.beginCreateTime}
            </if>
            <if test="paramsDto.endCreateTime != null">
                and t.create_time  &lt;= #{paramsDto.endCreateTime}
            </if>
        </where>
        group by w.id
    </select>
    <select id="findCrListForMineCarrier" resultType="com.cjyc.common.model.vo.web.waybill.CrWaybillVo">
        select
            w.no as waybillNo,
            w.id as waybillId,
            w.type as waybillType,
            w.carrier_name as carrierName,
            w.state as state,
            w.remark as remark,
            w.create_time as createTime,
            w.car_num as carNum,
            w.create_user as createUser,
            sum(IFNULL(w.car_num,0)) as hasAllottedNum
        from w_waybill w
        JOIN w_task t on w.id = t.waybill_id
        <where>
            w.carrier_id = #{paramsDto.carrierId}
            <if test="paramsDto.waybillNo != null and paramsDto.waybillNo != ''">
                and w.no = #{paramsDto.waybillNo}
            </if>
            <if test="paramsDto.waybillType != null and paramsDto.waybillType != ''">
                and w.type = #{paramsDto.waybillType}
            </if>
            <if test="paramsDto.createUser != null and paramsDto.createUser != ''">
                and w.create_user = #{paramsDto.createUser}
            </if>
        </where>
        group by w.id
        order by w.id desc
    </select>


    <!-- 查询该承运商下运单 -->
    <select id="findByCarrierId" resultType="com.cjyc.common.model.vo.web.mineCarrier.MyWaybillVo"
                parameterType="com.cjyc.common.model.dto.web.mineCarrier.MyWaybillDto">
          SELECT
            ww.id AS billId,
            ww.no AS billNo,
            ww.guide_line AS guideLine,
            ww.car_num AS totalCarNum,
            IFNULL( ( ww.car_num - sum( wt.car_num ) ), 0 ) AS allocateCarNum,
            dc.name AS carrierName,
            ww.remark AS remark,
            ww.create_time AS createTime,
            ww.create_user AS createUser
        FROM
            w_waybill ww
        LEFT JOIN w_task wt ON wt.waybill_id = ww.id
        LEFT JOIN d_carrier dc ON dc.id = ww.carrier_id
        <where>
            <if test="billNo != null and billNo.trim() != ''">
                  ww.no = #{billNo}
            </if>
            <if test="carrierId != null ">
                and dc.id = #{carrierId}
            </if>
            and dc.type = 2
            and dc.business_state = 0
            and dc.state = 2
            group by wt.id
        </where>
    </select>
    <select id="findCrListByCarrierId" resultType="java.util.List">

    </select>
    <select id="findWaitAllotListByCarrierIds"
            resultType="com.cjyc.common.model.vo.driver.waybill.WaitAllotVo">
        select
            w.id as waybillId,
            w.no as waybillNo,
            w.type as waybillType,
            w.guide_line as guideLine,
            w.carrier_id as carrierId,
            w.carrier_type as carrierType,
            w.carrier_name as carrierName,
            w.car_num as carNum,
            sum(IFNULL(t.car_num,0)) as allottedCarNum,
            w.freight_fee as freightFee,
            w.fixed_freight_fee as fixedFreightFee,
            w.remark as remark,
            w.create_time as createTime,
            w.create_user as createUser,
            w.create_user_id as createUserId
        from w_waybill w
        left join w_task t on t.waybill_id = w.id
        <where>
<!--           <if test="carrierIds != null">
               w.carrier_id in
               <foreach collection=""
           </if>-->
        </where>
        GROUP BY w.id
    </select>

    <!--查询待分配运单列表-->
    <select id="selectWaitHandleTaskPage" parameterType="com.cjyc.common.model.dto.driver.BaseDriverDto"
            resultType="com.cjyc.common.model.vo.driver.task.WaybillTaskVo">
        select
            w.id as waybillId,
            w.no as waybillNo,
            w.guide_line as guideLine,
            w.car_num as carNum,
            w.type as type,
            w.freight_fee as freightFee,
            car.expect_start_time as expectStartTime
        from
            w_waybill w
            left join w_waybill_car car on w.id = car.waybill_id
        where
            w.carrier_id in (select carrier_id
            from d_carrier_driver_con
            where driver_id = #{loginId} and state = ${@com.cjyc.common.model.enums.CommonStateEnum@CHECKED.code})
            and w.state = ${@com.cjyc.common.model.enums.waybill.WaybillStateEnum@ALLOT_CONFIRM.code}
            group by w.id
    </select>

</mapper>
